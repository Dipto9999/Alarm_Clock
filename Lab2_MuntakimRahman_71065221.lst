0000              1   ; Lab2_MuntakimRahman_71065221.asm:
0000              2   ;        A) Drives A 16x2 LCD Display Using 4-Bit Mode and Displays 12-Hour Clock Time
0000              3   ;   b) Generates A 2kHz Square Wave at Pin P1.7 Using an ISR For Timer 0.
0000              4   ;      Drives A Speaker When Alarm is Activated.
                  6   $LIST
0000              8   
0000              9   ;  N76E003 pinout:
0000             10   ;                               -------
0000             11   ;       PWM2/IC6/T0/AIN4/P0.5 -|1    20|- P0.4/AIN5/STADC/PWM3/IC3
0000             12   ;               TXD/AIN3/P0.6 -|2    19|- P0.3/PWM5/IC5/AIN6
0000             13   ;               RXD/AIN2/P0.7 -|3    18|- P0.2/ICPCK/OCDCK/RXD_1/[SCL]
0000             14   ;                    RST/P2.0 -|4    17|- P0.1/PWM4/IC4/MISO
0000             15   ;        INT0/OSCIN/AIN1/P3.0 -|5    16|- P0.0/PWM3/IC3/MOSI/T1
0000             16   ;              INT1/AIN0/P1.7 -|6    15|- P1.0/PWM2/IC2/SPCLK
0000             17   ;                         GND -|7    14|- P1.1/PWM1/IC1/AIN7/CLO
0000             18   ;[SDA]/TXD_1/ICPDA/OCDDA/P1.6 -|8    13|- P1.2/PWM0/IC0
0000             19   ;                         VDD -|9    12|- P1.3/SCL/[STADC]
0000             20   ;            PWM5/IC7/SS/P1.5 -|10   11|- P1.4/SDA/FB/PWM1
0000             21   ;                               -------
0000             22   ;
0000             23   
0000             24   ;-------------------;
0000             25   ; Clock FrEQUencies ;
0000             26   ;-------------------;
0000             27   CLK           EQU 16600000 ; Microcontroller System Frequency in Hz
0000             28   
0000             29   TIMER0_RATE   EQU 4096     ; 2048Hz Squarewave (Peak Amplitude of CEM-1203 Speaker)
0000             30   TIMER0_RELOAD EQU ((65536-(CLK/TIMER0_RATE)))
0000             31   
0000             32   TIMER2_RATE   EQU 1000     ; 1000Hz, for Timer Tick of 1ms
0000             33   TIMER2_RELOAD EQU ((65536-(CLK/TIMER2_RATE)))
0000             34   
0000             35   ;-----------------;
0000             36   ; Pin Definitions ;
0000             37   ;-----------------;
0000             38   SET_BUTTON           EQU P1.0 ; Pin 15
0000             39   HOUR_FORMAT_BUTTON   EQU P1.1 ; Pin 14
0000             40   
0000             41   DEC_BUTTON           EQU P0.5 ; Pin 1
0000             42   HOURS_BUTTON         EQU P3.0 ; Pin 5
0000             43   MINUTES_BUTTON       EQU P1.6 ; Pin 8
0000             44   SECONDS_BUTTON       EQU P1.5 ; Pin 10
0000             45   
0000             46   ALARM_OUT            EQU P1.7 ; Pin 6
0000             47   
0000             48   ;-------------------;
0000             49   ; Interrupt Vectors ;
0000             50   ;-------------------;
0000             51   ; Reset Vector
0000             52   ORG 0X0000
0000 0201C2      53       LJMP Main
0003             54   
0003             55   ; External Interrupt 0 Vector (Not Used)
0003             56   ORG 0X0003
0003 32          57            RETI
0004             58   
0004             59   ; Timer/Counter 0 Overflow Interrupt Vector
000B             60   ORG 0X000B
000B 020136      61            LJMP Timer0_ISR
000E             62   
000E             63   ; External Interrupt 1 vector (Not Used)
0013             64   ORG 0X0013
0013 32          65            RETI
0014             66   
0014             67   ; Timer/Counter 1 Overflow Interrupt Vector (Not Used)
001B             68   ORG 0X001B
001B 32          69            RETI
001C             70   
001C             71   ; Serial Port Receive/Transmit Interrupt Vector (Not Used)
0023             72   ORG 0X0023
0023 32          73            RETI
0024             74   
0024             75   ; Timer/Counter 2 Overflow Interrupt Vector
002B             76   ORG 0X002B
002B 020176      77            LJMP Timer2_ISR
002E             78   
002E             79   ; Note : Can Define Direct Access Variables Starting at 0X30 up to 0X7F in 8051.
0030             80   DSEG AT 0X30
0030             81   
0030             82   Counter_1ms:       DS 2 ; Used to Determine When 1000ms has Passed
0032             83   
0032             84   BCD_Time_Hours: DS 1
0033             85   BCD_Time_Minutes:  DS 1
0034             86   BCD_Time_Seconds:  DS 1
0035             87   
0035             88   BCD_Alarm_Hours: DS 1
0036             89   BCD_Alarm_Minutes: DS 1
0037             90   
0000             91   BSEG
0000             92   
0000             93   One_Second_Flag: DBIT 1 ; Set Bit In ISR After Every 1000ms
0001             94   
0001             95   Init_Time_Flag: DBIT 1 ; Set Bit When Time is Being Initialized
0002             96   Dec_En_Flag: DBIT 1 ; Set Bit When Decrement Button is Toggled
0003             97   
0003             98   Alarm_En_Flag:   DBIT 1
0004             99   Alarm_On_Flag:   DBIT 1
0005            100   
0005            101   Time_PM_Flag:    DBIT 1 ; Set Bit When Time is in PM
0006            102   Alarm_PM_Flag:   DBIT 1 ; Set Bit When Alarm is in PM
0007            103   Hour_Format_Flag:    DBIT 1 ; Set Bit When Time is in 24-Hour Mode
0008            104   
002E            105   CSEG
002E            106   
002E            107   LCD_RS EQU P1.3 ; Pin 12
002E            108   LCD_E  EQU P1.4 ; Pin 11
002E            109   LCD_D4 EQU P0.0 ; Pin 16
002E            110   LCD_D5 EQU P0.1 ; Pin 17
002E            111   LCD_D6 EQU P0.2 ; Pin 18
002E            112   LCD_D7 EQU P0.3 ; Pin 19
002E            113   
                115   	$LIST
00E2            117   
00E2 54494D45   118   TIME_INIT_MSG:     DB 'TIME xx:xx:xxxx', 0, 0
     2078783A
     78783A78
     78787800
     00
00F3 414C4152   119   ALARM_INIT_MSG:    DB 'ALARM xx:xxxx', 0
     4D207878
     3A787878
     7800
0101 414C4152   120   ALARM_UPDATE_MSG:  DB 'ALARM', 0
     4D00
0107            121   
0107 414D00     122   AM_MSG: DB 'AM', 0
010A 504D00     123   PM_MSG: DB 'PM', 0
010D            124   
010D 20202020   125   BLANK_DISPLAY: DB '                ', 0
     20202020
     20202020
     20202020
     00
011E 3A00       126   COLON: DB ':', 0
0120            127   
0120            128   ;---------------------------------------;
0120            129   ; Routine to Initialize ISR for Timer 0 ;
0120            130   ;---------------------------------------;
0120            131   Timer0_Init:
0120 438E08     132            ORL CKCON, #0B0000_1000 ; Input for Timer 0 is SYSCLK/1.
0123            133   
0123 E589       134            MOV A, TMOD
0125 54F0       135            ANL A, #0XF0 ; 1111_0000 Clear Bits for Timer 0
0127 4401       136            ORL A, #0X01 ; 0000_0001 Configure Timer 0 as 16-Timer
0129 F589       137            MOV TMOD, A
012B            138   
012B 758CF0     139            MOV TH0, #HIGH(TIMER0_RELOAD)
012E 758A2C     140            MOV TL0, #LOW(TIMER0_RELOAD)
0131            141   
0131            142            ; Enable Timer and Interrupts
0131 D2A9       143       SETB ET0  ; Enable Timer 0 Interrupt
0133 D28C       144            SETB TR0  ; Start Timer 0
0135 22         145            RET
0136            146   
0136            147   ;---------------------------------;
0136            148   ; ISR for Timer 0. Set to Execute ;
0136            149   ; Every 1/4096Hz to Generate a    ;
0136            150   ; 2048 Hz Wave at Pin ALARM_OUT   ;
0136            151   ;---------------------------------;
0136            152   Timer0_ISR:
0136            153            ; Save Registers to Stack.
0136 C0E0       154       PUSH ACC
0138 C0D0       155            PUSH PSW
013A            156   
013A 300311     157            JNB Alarm_En_Flag, No_Sound
013D 30040E     158            JNB Alarm_On_Flag, No_Sound
0140            159   Generate_Sound:
0140 C28C       160            CLR TR0 ; Stop Timer 0.
0142            161            ; Timer 0 Doesn't Have 16-Bit Auto-Reload.
0142 758CF0     162            MOV TH0, #HIGH(TIMER0_RELOAD)
0145 758A2C     163            MOV TL0, #LOW(TIMER0_RELOAD)
0148 D28C       164            SETB TR0
014A            165   
014A B297       166            CPL ALARM_OUT ; Toggle the Alarm Out Pin
014C 8006       167            SJMP Timer0_ISR_Done
014E            168   No_Sound:
014E            169            ; Timer 0 Doesn't Have 16-Bit Auto-Reload.
014E 758CF0     170            MOV TH0, #HIGH(TIMER0_RELOAD)
0151 758A2C     171            MOV TL0, #LOW(TIMER0_RELOAD)
0154            172   Timer0_ISR_Done:
0154            173            ; Restore Registers from Stack.
0154 D0D0       174            POP PSW
0156 D0E0       175            POP ACC
0158            176   
0158 32         177            RETI
0159            178   
0159            179   ;---------------------------------------;
0159            180   ; Routine to Initialize ISR for Timer 2 ;
0159            181   ;---------------------------------------;
0159            182   Timer2_Init:
0159 75C800     183            MOV T2CON, #0 ; Stop Timer. Autoreload Mode.
015C            184   
015C 75CDBF     185            MOV TH2, #HIGH(TIMER2_RELOAD)
015F 75CC28     186            MOV TL2, #LOW(TIMER2_RELOAD)
0162            187   
0162            188            ; Set Reload Value
0162 43C980     189            ORL T2MOD, #0X80 ; Enable Timer 2 Autoreload Mode
0165 75CBBF     190            MOV RCMP2H, #HIGH(TIMER2_RELOAD)
0168 75CA28     191            MOV RCMP2L, #LOW(TIMER2_RELOAD)
016B            192   
016B            193            ; Init 1ms Interrupt Counter. 16-bit Variable with Two 8-bit Parts.
016B E4         194            CLR A
016C F530       195            MOV Counter_1ms+0, A
016E F531       196            MOV Counter_1ms+1, A
0170            197   
0170            198            ; Enable the Timer and Interrupts.
0170 439B80     199            ORL EIE, #0X80 ; Enable Timer 2 Interrupt ET2=1
0173 D2CA       200       SETB TR2  ; Enable Timer 2
0175 22         201            RET
0176            202   
0176            203   ;-----------------;
0176            204   ; ISR for Timer 2 ;
0176            205   ;-----------------;
0176            206   Timer2_ISR:
0176 C2CF       207            CLR TF2  ; Timer 2 Doesn't Clear TF2 Automatically. Do it in the ISR.  It is Bit Addressable.
0178 B284       208            CPL P0.4 ; Interrupt Rate with Oscilloscope Must Precisely Be A 1ms Pulse.
017A            209   
017A            210            ; Save Registers to Stack
017A C0E0       211            PUSH ACC
017C C0D0       212            PUSH PSW
017E            213   
017E            214            ; Increment 16-bit 1ms Counter.
017E 0530       215            INC Counter_1ms+0 ; Increment Low 8-bits
0180 E530       216            MOV A, Counter_1ms+0 ; Increment High 8-bits if Lower 8-bits Overflow
0182 7002       217            JNZ Update_BCD
0184 0531       218            INC Counter_1ms+1
0186            219   Update_BCD:
0186            220            ; Check if 1000ms Have Passed
0186 E530       221            MOV A, Counter_1ms+0
0188 B4E832     222            CJNE A, #LOW(1000), Timer2_ISR_Done ; Note : Changes Carry Flag
018B E531       223            MOV A, Counter_1ms+1
018D B4032D     224            CJNE A, #HIGH(1000), Timer2_ISR_Done
0190            225   
0190            226            ; 1000ms Have Passed. Set Flag to Inform Main Program.
0190 D200       227            SETB One_Second_Flag
0192            228   Check_Alarm:
0192 30031E     229            JNB Alarm_En_Flag, No_Alarm
0195            230   
0195            231            ; Check if Time Hours Equals Alarm Hours
0195 E532       232            MOV A, BCD_Time_Hours
0197 B53519     233            CJNE A, BCD_Alarm_Hours, No_Alarm
019A            234   
019A            235            ; Check if Time Minutes Equals Alarm Minutes
019A E533       236            MOV A, BCD_Time_Minutes
019C B53614     237            CJNE A, BCD_Alarm_Minutes, No_Alarm
019F            238   
019F            239            ; Check AM/PM Flag
019F E4         240            CLR A
01A0 F5F0       241            MOV B, A
01A2 A205       242            MOV C, Time_PM_Flag
01A4 92F0       243            MOV B.0, C
01A6 A206       244            MOV C, Alarm_PM_Flag
01A8 92E0       245            MOV ACC.0, C
01AA B5F006     246            CJNE A, B, No_Alarm
01AD            247   BEEP:
01AD D204       248            SETB Alarm_On_Flag
01AF B28C       249            CPL TR0 ; Create Beep-Silence-Beep-Silence Sounds
01B1 8002       250            SJMP Continue_ISR
01B3            251   No_Alarm:
01B3 C204       252            CLR Alarm_On_Flag
01B5            253   Continue_ISR:
01B5            254            ; Reset 1ms Counter to 0.
01B5 E4         255            CLR A
01B6 F530       256            MOV Counter_1ms+0, A
01B8 F531       257            MOV Counter_1ms+1, A
01BA 1205B9     258            LCALL Update_Time_Seconds
01BD            259   Timer2_ISR_Done:
01BD D0D0       260            POP PSW
01BF D0E0       261            POP ACC
01C1 32         262            RETI
01C2            263   
01C2            264   ;----------------------------------;
01C2            265   ; Main Program. Includes Hardware  ;
01C2            266   ; Initialization and Forever Loop. ;
01C2            267   ;----------------------------------;
01C2            268   Main:
01C2            269            ; Initialization
01C2 75817F     270       MOV SP, #0X7F
01C5 75B100     271       MOV P0M1, #0X00
01C8 75B200     272       MOV P0M2, #0X00
01CB 75B300     273       MOV P1M1, #0X00
01CE 75B400     274       MOV P1M2, #0X00
01D1 75AD00     275       MOV P3M2, #0X00
01D4 75AD00     276       MOV P3M2, #0X00
01D7            277   
01D7 120120     278       LCALL Timer0_Init
01DA 120159     279       LCALL Timer2_Init
01DD D2AF       280       SETB EA   ; Enable Global Interrupts
01DF 120087     281       LCALL LCD_4BIT
01E2            282   
01E2            283   Init_Time:
01E2 D201       284            SETB Init_Time_Flag
01E4 D200       285       SETB One_Second_Flag
01E6 C205       286            CLR Time_PM_Flag
01E8 C202       287            CLR Dec_En_Flag
01EA C207       288            CLR Hour_Format_Flag
01EC            289   
01EC C2CA       290            CLR TR2 ; Stop Timer 2
01EE            291   
01EE            292            ; Starting Display is 8:00:00 AM
01EE 7408       293            MOV A, #0X08
01F0 F532       294            MOV BCD_Time_Hours, A
01F2            295   
01F2 7400       296            MOV A, #0X00
01F4 F533       297            MOV BCD_Time_Minutes, A
01F6            298   
01F6 7400       299            MOV A, #0X00
01F8 F534       300            MOV BCD_Time_Seconds, A
01FA            301   
01FA C0E0       302            push acc
01FC 7401       302            mov a, #1
01FE 14         302            dec a
01FF 1200C7     302            lcall ?Set_Cursor_1 ; Select column and row
0202 D0E0       302            pop acc
0204 C083       303            push dph
0206 C082       303            push dpl
0208 C0E0       303            push acc
020A 9000E2     303            mov dptr, #TIME_INIT_MSG
020D 1200BA     303            lcall ?Send_Constant_String
0210 D0E0       303            pop acc
0212 D082       303            pop dpl
0214 D083       303            pop dph
0216            304   Check_Set_Time:
0216 209012     305            JB SET_BUTTON, Init_Time_Display
0219 C002       306            push AR2
021B 7A32       306            mov R2, #50
021D 120038     306            lcall ?Wait_Milli_Seconds
0220 D002       306            pop AR2
0222 209006     307            JB SET_BUTTON, Init_Time_Display
0225 3090FD     308            JNB SET_BUTTON, $ ; Wait for Rising Edge
0228 020276     309            LJMP Init_Time_End
022B            310   Init_Time_Display:
022B 12067E     311            LCALL Check_Hour_Format
022E 1202D3     312            LCALL Update_Time_Display
0231 120669     313            LCALL Check_Dec_En
0234            314   Init_Time_Seconds:
0234 209512     315            JB SECONDS_BUTTON, Init_Time_Minutes
0237 C002       316            push AR2
0239 7A32       316            mov R2, #50
023B 120038     316            lcall ?Wait_Milli_Seconds
023E D002       316            pop AR2
0240 209506     317            JB SECONDS_BUTTON, Init_Time_Minutes
0243 3095FD     318            JNB SECONDS_BUTTON, $ ; Wait for Rising Edge
0246 1205B9     319            LCALL Update_Time_Seconds
0249            320   Init_Time_Minutes:
0249 209612     321            JB MINUTES_BUTTON, Init_Time_Hours
024C C002       322            push AR2
024E 7A32       322            mov R2, #50
0250 120038     322            lcall ?Wait_Milli_Seconds
0253 D002       322            pop AR2
0255 209606     323            JB MINUTES_BUTTON, Init_Time_Hours
0258 3096FD     324            JNB MINUTES_BUTTON, $ ; Wait for Rising Edge
025B 120588     325            LCALL Update_Time_Minutes
025E            326   Init_Time_Hours:
025E 20B012     327            JB HOURS_BUTTON, Init_Time_Loop
0261 C002       328            push AR2
0263 7A32       328            mov R2, #50
0265 120038     328            lcall ?Wait_Milli_Seconds
0268 D002       328            pop AR2
026A 20B006     329            JB HOURS_BUTTON, Init_Time_Loop
026D 30B0FD     330            JNB HOURS_BUTTON, $ ; Wait for Rising Edge
0270 12054B     331            LCALL Update_Time_Hours
0273            332   Init_Time_Loop:
0273 020216     333            LJMP Check_Set_Time
0276            334   Init_Time_End:
0276 D2CA       335            SETB TR2 ; Set Timer 2
0278 C201       336            CLR Init_Time_Flag
027A            337   Init_Alarm:
027A D203       338            SETB Alarm_En_Flag
027C C204       339            CLR Alarm_On_Flag
027E            340   
027E            341            ; Starting Alarm is 06:00 AM
027E C206       342            CLR Alarm_PM_Flag
0280 7406       343            MOV A, #0X06
0282 F535       344            MOV BCD_Alarm_Hours, A
0284            345   
0284 7400       346            MOV A, #0X00
0286 F536       347            MOV BCD_Alarm_Minutes, A
0288            348   
0288 0202C5     349            LJMP Update_LCD_Display
028B            350   
028B            351   ;------------------------------------------------------;
028B            352   ; Forever Loop to Check Buttons and Update LCD Display ;
028B            353   ;------------------------------------------------------;
028B            354   Check_Buttons:
028B 8000       355            SJMP Check_Update_Alarm
028D            356   Check_Update_Alarm:
028D 120654     357            LCALL Check_Alarm_En
0290 120669     358            LCALL Check_Dec_En
0293 200303     359            JB Alarm_En_Flag, Check_Update_Alarm_Minutes
0296 0202C5     360            LJMP Update_LCD_Display
0299            361   Check_Update_Alarm_Minutes:
0299 209612     362            JB MINUTES_BUTTON, Check_Update_Alarm_Hours
029C C002       363            push AR2
029E 7A32       363            mov R2, #50
02A0 120038     363            lcall ?Wait_Milli_Seconds
02A3 D002       363            pop AR2
02A5 209606     364            JB MINUTES_BUTTON, Check_Update_Alarm_Hours
02A8 3096FD     365            JNB MINUTES_BUTTON, $ ; Wait for Rising Edge
02AB 120626     366            LCALL Update_Alarm_Minutes ; Increment Alarm Minutes
02AE            367   Check_Update_Alarm_Hours:
02AE 20B014     368            JB HOURS_BUTTON, Update_LCD_Display
02B1 C002       369            push AR2
02B3 7A32       369            mov R2, #50
02B5 120038     369            lcall ?Wait_Milli_Seconds
02B8 D002       369            pop AR2
02BA 20B008     370            JB HOURS_BUTTON, Update_LCD_Display
02BD 30B0FD     371            JNB HOURS_BUTTON, $ ; Wait for Rising Edge
02C0 1205EA     372            LCALL Update_Alarm_Hours ; Increment Alarm Hours
02C3 8000       373            SJMP Update_LCD_Display
02C5            374   Update_LCD_Display:
02C5 C200       375       CLR One_Second_Flag
02C7 12067E     376            LCALL Check_Hour_Format
02CA 1202D3     377            LCALL Update_Time_Display
02CD 120407     378            LCALL Update_Alarm_Display
02D0 02028B     379            LJMP Check_Buttons
02D3            380   
02D3            381   ;--------------------;
02D3            382   ; Update LCD Display ;
02D3            383   ;--------------------;
02D3            384   Update_Time_Display:
02D3            385            ; Display Time
02D3 C0E0       386            push acc
02D5 7409       386            mov a, #9
02D7 14         386            dec a
02D8 1200C7     386            lcall ?Set_Cursor_1 ; Select column and row
02DB D0E0       386            pop acc
02DD C000       387            push ar0
02DF A833       387            mov r0, BCD_Time_Minutes
02E1 1200CC     387            lcall ?Display_BCD
02E4 D000       387            pop ar0
02E6 C0E0       388            push acc
02E8 740C       388            mov a, #12
02EA 14         388            dec a
02EB 1200C7     388            lcall ?Set_Cursor_1 ; Select column and row
02EE D0E0       388            pop acc
02F0 C000       389            push ar0
02F2 A834       389            mov r0, BCD_Time_Seconds
02F4 1200CC     389            lcall ?Display_BCD
02F7 D000       389            pop ar0
02F9            390   
02F9 200755     391            JB Hour_Format_Flag, Update_Time_Hours_24
02FC 8000       392            SJMP Update_Time_Hours_12
02FE            393   Update_Time_Hours_12:
02FE C0E0       394            push acc
0300 7406       394            mov a, #6
0302 14         394            dec a
0303 1200C7     394            lcall ?Set_Cursor_1 ; Select column and row
0306 D0E0       394            pop acc
0308 C000       395            push ar0
030A A832       395            mov r0, BCD_Time_Hours
030C 1200CC     395            lcall ?Display_BCD
030F D000       395            pop ar0
0311 20051E     396            JB Time_PM_Flag, Update_Time_PM
0314            397   Update_Time_AM:
0314 C0E0       398            push acc
0316 740E       398            mov a, #14
0318 14         398            dec a
0319 1200C7     398            lcall ?Set_Cursor_1 ; Select column and row
031C D0E0       398            pop acc
031E C083       399            push dph
0320 C082       399            push dpl
0322 C0E0       399            push acc
0324 900107     399            mov dptr, #AM_MSG
0327 1200BA     399            lcall ?Send_Constant_String
032A D0E0       399            pop acc
032C D082       399            pop dpl
032E D083       399            pop dph
0330 801E       400            SJMP Update_Time_Display_End
0332            401   Update_Time_PM:
0332 C0E0       402            push acc
0334 740E       402            mov a, #14
0336 14         402            dec a
0337 1200C7     402            lcall ?Set_Cursor_1 ; Select column and row
033A D0E0       402            pop acc
033C C083       403            push dph
033E C082       403            push dpl
0340 C0E0       403            push acc
0342 90010A     403            mov dptr, #PM_MSG
0345 1200BA     403            lcall ?Send_Constant_String
0348 D0E0       403            pop acc
034A D082       403            pop dpl
034C D083       403            pop dph
034E 8000       404            SJMP Update_Time_Display_End
0350            405   Update_Time_Display_End:
0350 22         406            RET
0351            407   
0351            408   Update_Time_Hours_24:
0351 C0E0       409            push acc
0353 740E       409            mov a, #14
0355 14         409            dec a
0356 1200C7     409            lcall ?Set_Cursor_1 ; Select column and row
0359 D0E0       409            pop acc
035B C083       410            push dph
035D C082       410            push dpl
035F C0E0       410            push acc
0361 90010D     410            mov dptr, #BLANK_DISPLAY
0364 1200BA     410            lcall ?Send_Constant_String
0367 D0E0       410            pop acc
0369 D082       410            pop dpl
036B D083       410            pop dph
036D E532       411            MOV A, BCD_Time_Hours
036F 20052C     412            JB Time_PM_Flag, Update_Time_Hours_24_PM
0372            413   Update_Time_Hours_24_AM:
0372 C0E0       414            push acc
0374 7406       414            mov a, #6
0376 14         414            dec a
0377 1200C7     414            lcall ?Set_Cursor_1 ; Select column and row
037A D0E0       414            pop acc
037C C000       415            push ar0
037E F8         415            mov r0, A
037F 1200CC     415            lcall ?Display_BCD
0382 D000       415            pop ar0
0384 B412C9     416            CJNE A, #0X12, Update_Time_Display_End
0387 8000       417            SJMP Update_Time_0000
0389            418   Update_Time_0000:
0389 C0E0       419            push acc
038B 7406       419            mov a, #6
038D 14         419            dec a
038E 1200C7     419            lcall ?Set_Cursor_1 ; Select column and row
0391 D0E0       419            pop acc
0393 C000       420            push ar0
0395 7800       420            mov r0, #0X00
0397 1200CC     420            lcall ?Display_BCD
039A D000       420            pop ar0
039C 80B2       421            SJMP Update_Time_Display_End
039E            422   Update_Time_Hours_24_PM:
039E 2412       423            ADD A, #0X12
03A0 C0E0       424            push acc
03A2 7406       424            mov a, #6
03A4 14         424            dec a
03A5 1200C7     424            lcall ?Set_Cursor_1 ; Select column and row
03A8 D0E0       424            pop acc
03AA C000       425            push ar0
03AC F8         425            mov r0, A
03AD 1200CC     425            lcall ?Display_BCD
03B0 D000       425            pop ar0
03B2 E532       426            MOV A, BCD_Time_Hours
03B4 8000       427            SJMP Check_Time_2000
03B6            428   Check_Time_2000:
03B6 B40802     429            CJNE A, #0X08, Check_Time_2100
03B9 800A       430            SJMP Update_Time_2000
03BB            431   Check_Time_2100:
03BB B40902     432            CJNE A, #0X09, Check_Time_1200
03BE 801B       433            SJMP Update_Time_2100
03C0            434   Check_Time_1200:
03C0 B4128D     435            CJNE A, #0X12, Update_Time_Display_End
03C3 802C       436            SJMP Update_Time_1200
03C5            437   Update_Time_2000:
03C5 C0E0       438            push acc
03C7 7406       438            mov a, #6
03C9 14         438            dec a
03CA 1200C7     438            lcall ?Set_Cursor_1 ; Select column and row
03CD D0E0       438            pop acc
03CF C000       439            push ar0
03D1 7820       439            mov r0, #0x20
03D3 1200CC     439            lcall ?Display_BCD
03D6 D000       439            pop ar0
03D8 020350     440            LJMP Update_Time_Display_End
03DB            441   Update_Time_2100:
03DB C0E0       442            push acc
03DD 7406       442            mov a, #6
03DF 14         442            dec a
03E0 1200C7     442            lcall ?Set_Cursor_1 ; Select column and row
03E3 D0E0       442            pop acc
03E5 C000       443            push ar0
03E7 7821       443            mov r0, #0x021
03E9 1200CC     443            lcall ?Display_BCD
03EC D000       443            pop ar0
03EE 020350     444            LJMP Update_Time_Display_End
03F1            445   Update_Time_1200:
03F1 C0E0       446            push acc
03F3 7406       446            mov a, #6
03F5 14         446            dec a
03F6 1200C7     446            lcall ?Set_Cursor_1 ; Select column and row
03F9 D0E0       446            pop acc
03FB C000       447            push ar0
03FD 7812       447            mov r0, #0X12
03FF 1200CC     447            lcall ?Display_BCD
0402 D000       447            pop ar0
0404 020350     448            LJMP Update_Time_Display_End
0407            449   
0407            450   
0407            451   Update_Alarm_Display:
0407 200303     452            JB Alarm_En_Flag, Update_Alarm_En_On
040A 02052C     453            LJMP Update_Alarm_En_Off
040D            454   Update_Alarm_En_On:
040D            455            ; Display Alarm
040D C0E0       456            push acc
040F 7401       456            mov a, #1
0411 14         456            dec a
0412 1200C5     456            lcall ?Set_Cursor_2 ; Select column and row
0415 D0E0       456            pop acc
0417 C083       457            push dph
0419 C082       457            push dpl
041B C0E0       457            push acc
041D 900101     457            mov dptr, #ALARM_UPDATE_MSG
0420 1200BA     457            lcall ?Send_Constant_String
0423 D0E0       457            pop acc
0425 D082       457            pop dpl
0427 D083       457            pop dph
0429 C0E0       458            push acc
042B 7409       458            mov a, #9
042D 14         458            dec a
042E 1200C5     458            lcall ?Set_Cursor_2 ; Select column and row
0431 D0E0       458            pop acc
0433 C083       459            push dph
0435 C082       459            push dpl
0437 C0E0       459            push acc
0439 90011E     459            mov dptr, #COLON
043C 1200BA     459            lcall ?Send_Constant_String
043F D0E0       459            pop acc
0441 D082       459            pop dpl
0443 D083       459            pop dph
0445            459   
0445 C0E0       460            push acc
0447 740A       460            mov a, #10
0449 14         460            dec a
044A 1200C5     460            lcall ?Set_Cursor_2 ; Select column and row
044D D0E0       460            pop acc
044F C000       461            push ar0
0451 A836       461            mov r0, BCD_Alarm_Minutes
0453 1200CC     461            lcall ?Display_BCD
0456 D000       461            pop ar0
0458            462   
0458 200755     463            JB Hour_Format_Flag, Update_Alarm_Hours_24
045B 8000       464            SJMP Update_Alarm_Hours_12
045D            465   Update_Alarm_Hours_12:
045D C0E0       466            push acc
045F 7407       466            mov a, #7
0461 14         466            dec a
0462 1200C5     466            lcall ?Set_Cursor_2 ; Select column and row
0465 D0E0       466            pop acc
0467 C000       467            push ar0
0469 A835       467            mov r0, BCD_Alarm_Hours
046B 1200CC     467            lcall ?Display_BCD
046E D000       467            pop ar0
0470 20061E     468            JB Alarm_PM_Flag, Update_Alarm_PM
0473            469   Update_Alarm_AM:
0473 C0E0       470            push acc
0475 740C       470            mov a, #12
0477 14         470            dec a
0478 1200C5     470            lcall ?Set_Cursor_2 ; Select column and row
047B D0E0       470            pop acc
047D C083       471            push dph
047F C082       471            push dpl
0481 C0E0       471            push acc
0483 900107     471            mov dptr, #AM_MSG
0486 1200BA     471            lcall ?Send_Constant_String
0489 D0E0       471            pop acc
048B D082       471            pop dpl
048D D083       471            pop dph
048F 801E       472       SJMP Update_Alarm_Display_End
0491            473   Update_Alarm_PM:
0491 C0E0       474            push acc
0493 740C       474            mov a, #12
0495 14         474            dec a
0496 1200C5     474            lcall ?Set_Cursor_2 ; Select column and row
0499 D0E0       474            pop acc
049B C083       475            push dph
049D C082       475            push dpl
049F C0E0       475            push acc
04A1 90010A     475            mov dptr, #PM_MSG
04A4 1200BA     475            lcall ?Send_Constant_String
04A7 D0E0       475            pop acc
04A9 D082       475            pop dpl
04AB D083       475            pop dph
04AD 8000       476       SJMP Update_Alarm_Display_End
04AF            477   Update_Alarm_Display_End:
04AF 22         478            RET
04B0            479   
04B0            480   Update_Alarm_Hours_24:
04B0 C0E0       481            push acc
04B2 740C       481            mov a, #12
04B4 14         481            dec a
04B5 1200C5     481            lcall ?Set_Cursor_2 ; Select column and row
04B8 D0E0       481            pop acc
04BA C083       482            push dph
04BC C082       482            push dpl
04BE C0E0       482            push acc
04C0 90010D     482            mov dptr, #BLANK_DISPLAY
04C3 1200BA     482            lcall ?Send_Constant_String
04C6 D0E0       482            pop acc
04C8 D082       482            pop dpl
04CA D083       482            pop dph
04CC E535       483            MOV A, BCD_Alarm_Hours
04CE 20062C     484            JB Alarm_PM_Flag, Update_Alarm_Hours_24_PM
04D1            485   Update_Alarm_Hours_24_AM:
04D1 C0E0       486            push acc
04D3 7407       486            mov a, #7
04D5 14         486            dec a
04D6 1200C5     486            lcall ?Set_Cursor_2 ; Select column and row
04D9 D0E0       486            pop acc
04DB C000       487            push ar0
04DD F8         487            mov r0, A
04DE 1200CC     487            lcall ?Display_BCD
04E1 D000       487            pop ar0
04E3 B412C9     488            CJNE A, #0X12, Update_Alarm_Display_End
04E6 8000       489            SJMP Update_Alarm_0000
04E8            490   Update_Alarm_0000:
04E8 C0E0       491            push acc
04EA 7407       491            mov a, #7
04EC 14         491            dec a
04ED 1200C5     491            lcall ?Set_Cursor_2 ; Select column and row
04F0 D0E0       491            pop acc
04F2 C000       492            push ar0
04F4 7800       492            mov r0, #0X00
04F6 1200CC     492            lcall ?Display_BCD
04F9 D000       492            pop ar0
04FB 80B2       493            SJMP Update_Alarm_Display_End
04FD            494   Update_Alarm_Hours_24_PM:
04FD 240C       495            ADD A, #12
04FF D4         496            DA A
0500 C0E0       497            push acc
0502 7407       497            mov a, #7
0504 14         497            dec a
0505 1200C5     497            lcall ?Set_Cursor_2 ; Select column and row
0508 D0E0       497            pop acc
050A C000       498            push ar0
050C F8         498            mov r0, A
050D 1200CC     498            lcall ?Display_BCD
0510 D000       498            pop ar0
0512 B4249A     499            CJNE A, #0X24, Update_Alarm_Display_End
0515 8000       500            SJMP Update_Alarm_1200
0517            501   Update_Alarm_1200:
0517 C0E0       502            push acc
0519 7407       502            mov a, #7
051B 14         502            dec a
051C 1200C5     502            lcall ?Set_Cursor_2 ; Select column and row
051F D0E0       502            pop acc
0521 C000       503            push ar0
0523 7812       503            mov r0, #0X12
0525 1200CC     503            lcall ?Display_BCD
0528 D000       503            pop ar0
052A 8083       504            SJMP Update_Alarm_Display_End
052C            505   
052C            506   Update_Alarm_En_Off:
052C C0E0       507            push acc
052E 7401       507            mov a, #1
0530 14         507            dec a
0531 1200C5     507            lcall ?Set_Cursor_2 ; Select column and row
0534 D0E0       507            pop acc
0536 C083       508            push dph
0538 C082       508            push dpl
053A C0E0       508            push acc
053C 90010D     508            mov dptr, #BLANK_DISPLAY
053F 1200BA     508            lcall ?Send_Constant_String
0542 D0E0       508            pop acc
0544 D082       508            pop dpl
0546 D083       508            pop dph
0548 0204AF     509            LJMP Update_Alarm_Display_End
054B            510   
054B            511   ;-------------------------------;
054B            512   ; Update Time on LCD Display ;
054B            513   ;-------------------------------;
054B            514   Update_Time_Hours:
054B 300106     515            JNB Init_Time_Flag, Inc_Time_Hours
054E 300203     516            JNB Dec_En_Flag, Inc_Time_Hours
0551 020570     517            LJMP Dec_Time_Hours
0554            518   
0554            519   Inc_Time_Hours:
0554 E532       520            MOV A, BCD_Time_Hours
0556 2401       521            ADD A, #1
0558 D4         522            DA A
0559 F532       523            MOV BCD_Time_Hours, A
055B 9412       524            SUBB A, #0X12
055D 4010       525            JC Update_Time_Hours_Done
055F 7007       526            JNZ Offset_Time_Hours
0561            527   Toggle_Time_AMPM:
0561 753212     528            MOV BCD_Time_Hours, #0X12
0564 B205       529            CPL Time_PM_Flag
0566 8007       530            SJMP Update_Time_Hours_Done
0568            531   Offset_Time_Hours:
0568 E532       532            MOV A, BCD_Time_Hours
056A 9412       533            SUBB A, #0X12
056C D4         534            DA A
056D F532       535            MOV BCD_Time_Hours, A
056F            536   Update_Time_Hours_Done:
056F 22         537            RET
0570            538   
0570            539   Dec_Time_Hours:
0570 E532       540            MOV A, BCD_Time_Hours
0572 B41207     541            CJNE A, #0X12, Dec_Time_Hours_Continued
0575            542   Rewind_Time_AMPM:
0575 753211     543            MOV BCD_Time_Hours, #0X11
0578 B205       544            CPL Time_PM_Flag
057A 80F3       545            SJMP Update_Time_Hours_Done
057C            546   Dec_Time_Hours_Continued:
057C 2499       547            ADD A, #0X99 ; Adding 10-Complement of -1
057E D4         548            DA A
057F F532       549            MOV BCD_Time_Hours, A
0581 70EC       550            JNZ Update_Time_Hours_Done
0583            551   Rewind_Time_Hours:
0583 753212     552            MOV BCD_Time_Hours, #0X12
0586 80E7       553            SJMP Update_Time_Hours_Done
0588            554   
0588            555   
0588            556   Update_Time_Minutes:
0588 300106     557            JNB Init_Time_Flag, Inc_Time_Minutes
058B 300203     558            JNB Dec_En_Flag, Inc_Time_Minutes
058E 0205A6     559            LJMP Dec_Time_Minutes
0591            560   
0591            561   Inc_Time_Minutes:
0591 E533       562            MOV A, BCD_Time_Minutes
0593 2401       563            ADD A, #1
0595 D4         564            DA A
0596 F533       565            MOV BCD_Time_Minutes, A
0598 B4600A     566            CJNE A, #0X60, Update_Time_Minutes_Done
059B 8000       567            SJMP Reset_Time_Minutes
059D            568   Reset_Time_Minutes:
059D 753300     569            MOV BCD_Time_Minutes, #0X00
05A0 12054B     570            LCALL Update_Time_Hours
05A3 8000       571            SJMP Update_Time_Minutes_Done
05A5            572   Update_Time_Minutes_Done:
05A5 22         573            RET
05A6            574   
05A6            575   Dec_Time_Minutes:
05A6 E533       576            MOV A, BCD_Time_Minutes
05A8 7008       577            JNZ Dec_Time_Minutes_Continued
05AA            578   Rewind_Time_Minutes:
05AA 753359     579            MOV BCD_Time_Minutes, #0X59
05AD 12054B     580            LCALL Update_Time_Hours
05B0 80F3       581            SJMP Update_Time_Minutes_Done
05B2            582   Dec_Time_Minutes_Continued:
05B2 2499       583            ADD A, #0X99 ; Adding 10-Complement of -1
05B4 D4         584            DA A
05B5 F533       585            MOV BCD_Time_Minutes, A
05B7 80EC       586            SJMP Update_Time_Minutes_Done
05B9            587   
05B9            588   Update_Time_Seconds:
05B9 300106     589            JNB Init_Time_Flag, Inc_Time_Seconds
05BC 300203     590            JNB Dec_En_Flag, Inc_Time_Seconds
05BF 0205D7     591            LJMP Dec_Time_Seconds
05C2            592   
05C2            593   Inc_Time_Seconds:
05C2 E534       594            MOV A, BCD_Time_Seconds
05C4 2401       595            ADD A, #1
05C6 D4         596            DA A
05C7 F534       597            MOV BCD_Time_Seconds, A
05C9 B4600A     598            CJNE A, #0X60, Update_Time_Seconds_Done
05CC 8000       599            SJMP Reset_Time_Seconds
05CE            600   Reset_Time_Seconds:
05CE 753400     601            MOV BCD_Time_Seconds, #0X00
05D1 120588     602            LCALL Update_Time_Minutes
05D4 8000       603            SJMP Update_Time_Seconds_Done
05D6            604   Update_Time_Seconds_Done:
05D6 22         605            RET
05D7            606   
05D7            607   Dec_Time_Seconds:
05D7 E534       608            MOV A, BCD_Time_Seconds
05D9 7008       609            JNZ Dec_Time_Seconds_Continued
05DB            610   Rewind_Time_Seconds:
05DB 753459     611            MOV BCD_Time_Seconds, #0X59
05DE 120588     612            LCALL Update_Time_Minutes
05E1 80F3       613            SJMP Update_Time_Seconds_Done
05E3            614   Dec_Time_Seconds_Continued:
05E3 2499       615            ADD A, #0X99 ; Adding 10-Complement of -1
05E5 D4         616            DA A
05E6 F534       617            MOV BCD_Time_Seconds, A
05E8 80EC       618            SJMP Update_Time_Seconds_Done
05EA            619   
05EA            620   Update_Alarm_Hours:
05EA 300203     621            JNB Dec_En_Flag, Inc_Alarm_Hours
05ED 02060E     622            LJMP Dec_Alarm_Hours
05F0            623   
05F0            624   Inc_Alarm_Hours:
05F0 E535       625            MOV A, BCD_Alarm_Hours
05F2 2401       626            ADD A, #1
05F4 D4         627            DA A
05F5 F535       628            MOV BCD_Alarm_Hours, A
05F7 9412       629            SUBB A, #0X12
05F9 4012       630            JC Update_Alarm_Hours_Done
05FB 7007       631            JNZ Offset_Alarm_Hours
05FD            632   Toggle_Alarm_AMPM:
05FD 753512     633            MOV BCD_Alarm_Hours, #0X12
0600 B206       634            CPL Alarm_PM_Flag
0602 8009       635            SJMP Update_Alarm_Hours_Done
0604            636   Offset_Alarm_Hours:
0604 E535       637            MOV A, BCD_Alarm_Hours
0606 9412       638            SUBB A, #0X12
0608 D4         639            DA A
0609 F535       640            MOV BCD_Alarm_Hours, A
060B 8000       641            SJMP Update_Alarm_Hours_Done
060D            642   Update_Alarm_Hours_Done:
060D 22         643            RET
060E            644   
060E            645   Dec_Alarm_Hours:
060E E535       646            MOV A, BCD_Alarm_Hours
0610 B41207     647            CJNE A, #0X12, Dec_Alarm_Hours_Continued
0613            648   Rewind_Alarm_AMPM:
0613 753511     649            MOV BCD_Alarm_Hours, #0X11
0616 B206       650            CPL Alarm_PM_Flag
0618 80F3       651            SJMP Update_Alarm_Hours_Done
061A            652   Dec_Alarm_Hours_Continued:
061A 2499       653            ADD A, #0X99 ; Adding 10-Complement of -1
061C D4         654            DA A
061D F535       655            MOV BCD_Alarm_Hours, A
061F 70EC       656            JNZ Update_Alarm_Hours_Done
0621            657   Rewind_Alarm_Hours:
0621 753512     658            MOV BCD_Alarm_Hours, #0X12
0624 80E7       659            SJMP Update_Alarm_Hours_Done
0626            660   
0626            661   
0626            662   Update_Alarm_Minutes:
0626 300203     663            JNB Dec_En_Flag, Inc_Alarm_Minutes
0629 020641     664            LJMP Dec_Alarm_Minutes
062C            665   
062C            666   Inc_Alarm_Minutes:
062C E536       667            MOV A, BCD_Alarm_Minutes
062E 2401       668            ADD A, #1
0630 D4         669            DA A
0631 F536       670            MOV BCD_Alarm_Minutes, A
0633 B4600A     671            CJNE A, #0X60, Update_Alarm_Minutes_Done
0636 8000       672            SJMP Reset_Alarm_Minutes
0638            673   Reset_Alarm_Minutes:
0638 753600     674            MOV BCD_Alarm_Minutes, #0X00
063B 1205EA     675            LCALL Update_Alarm_Hours
063E 8000       676            SJMP Update_Alarm_Minutes_Done
0640            677   Update_Alarm_Minutes_Done:
0640 22         678            RET
0641            679   
0641            680   Dec_Alarm_Minutes:
0641 E536       681            MOV A, BCD_Alarm_Minutes
0643 7008       682            JNZ Dec_Alarm_Minutes_Continued
0645            683   Rewind_Alarm_Minutes:
0645 753659     684            MOV BCD_Alarm_Minutes, #0X59
0648 1205EA     685            LCALL Update_Alarm_Hours
064B 80F3       686            SJMP Update_Alarm_Minutes_Done
064D            687   Dec_Alarm_Minutes_Continued:
064D 2499       688            ADD A, #0X99 ; Adding 10-Complement of -1
064F D4         689            DA A
0650 F536       690            MOV BCD_Alarm_Minutes, A
0652 80EC       691            SJMP Update_Alarm_Minutes_Done
0654            692   
0654            693   ;----------------;
0654            694   ; Enable/Disable ;
0654            695   ;----------------;
0654            696   Check_Alarm_En:
0654 209011     697            JB SET_BUTTON, Check_Alarm_En_Done
0657 C002       698            push AR2
0659 7A32       698            mov R2, #50
065B 120038     698            lcall ?Wait_Milli_Seconds
065E D002       698            pop AR2
0660 209005     699            JB SET_BUTTON, Check_Alarm_En_Done
0663 3090FD     700            JNB SET_BUTTON, $ ; Wait for Rising Edge
0666 B203       701            CPL Alarm_En_Flag ; Toggle Alarm Enable Flag
0668            702   Check_Alarm_En_Done:
0668 22         703            RET
0669            704   
0669            705   Check_Dec_En:
0669 208511     706            JB DEC_BUTTON, Check_Dec_En_Done
066C C002       707            push AR2
066E 7A32       707            mov R2, #50
0670 120038     707            lcall ?Wait_Milli_Seconds
0673 D002       707            pop AR2
0675 208505     708            JB DEC_BUTTON, Check_Dec_En_Done
0678 3085FD     709            JNB DEC_BUTTON, $ ; Wait for Rising Edge
067B B202       710            CPL Dec_En_Flag
067D            711   Check_Dec_En_Done:
067D 22         712            RET
067E            713   
067E            714   Check_Hour_Format:
067E 209111     715            JB HOUR_FORMAT_BUTTON, Check_Hour_Format_Done
0681 C002       716            push AR2
0683 7A32       716            mov R2, #50
0685 120038     716            lcall ?Wait_Milli_Seconds
0688 D002       716            pop AR2
068A 209105     717            JB HOUR_FORMAT_BUTTON, Check_Hour_Format_Done
068D 3091FD     718            JNB HOUR_FORMAT_BUTTON, $ ; Wait for Rising Edge
0690 B207       719            CPL Hour_Format_Flag
0692            720   Check_Hour_Format_Done:
0692 22         721            RET
0693            722   END
