0000              1   ; Lab2_MuntakimRahman_71065221.asm:
0000              2   ;        A) Drives A 16x2 LCD Display Using 4-Bit Mode and Displays 12-Hour Clock Time
0000              3   ;   b) Generates A 2kHz Square Wave at Pin P1.7 Using an ISR For Timer 0.
0000              4   ;      Drives A Speaker When Alarm is Activated.
                  6   $LIST
0000              8   
0000              9   ;  N76E003 pinout:
0000             10   ;                               -------
0000             11   ;       PWM2/IC6/T0/AIN4/P0.5 -|1    20|- P0.4/AIN5/STADC/PWM3/IC3
0000             12   ;               TXD/AIN3/P0.6 -|2    19|- P0.3/PWM5/IC5/AIN6
0000             13   ;               RXD/AIN2/P0.7 -|3    18|- P0.2/ICPCK/OCDCK/RXD_1/[SCL]
0000             14   ;                    RST/P2.0 -|4    17|- P0.1/PWM4/IC4/MISO
0000             15   ;        INT0/OSCIN/AIN1/P3.0 -|5    16|- P0.0/PWM3/IC3/MOSI/T1
0000             16   ;              INT1/AIN0/P1.7 -|6    15|- P1.0/PWM2/IC2/SPCLK
0000             17   ;                         GND -|7    14|- P1.1/PWM1/IC1/AIN7/CLO
0000             18   ;[SDA]/TXD_1/ICPDA/OCDDA/P1.6 -|8    13|- P1.2/PWM0/IC0
0000             19   ;                         VDD -|9    12|- P1.3/SCL/[STADC]
0000             20   ;            PWM5/IC7/SS/P1.5 -|10   11|- P1.4/SDA/FB/PWM1
0000             21   ;                               -------
0000             22   ;
0000             23   
0000             24   ;-------------------;
0000             25   ; Clock FrEQUencies ;
0000             26   ;-------------------;
0000             27   CLK           EQU 16600000 ; Microcontroller System Frequency in Hz
0000             28   
0000             29   TIMER0_RATE   EQU 4096     ; 2048Hz Squarewave (Peak Amplitude of CEM-1203 Speaker)
0000             30   TIMER0_RELOAD EQU ((65536-(CLK/TIMER0_RATE)))
0000             31   
0000             32   TIMER2_RATE   EQU 1000     ; 1000Hz, for Timer Tick of 1ms
0000             33   TIMER2_RELOAD EQU ((65536-(CLK/TIMER2_RATE)))
0000             34   
0000             35   ;-----------------;
0000             36   ; Pin Definitions ;
0000             37   ;-----------------;
0000             38   SET_BUTTON           EQU P1.0 ; Pin 15
0000             39   HOUR_FORMAT_BUTTON   EQU P1.1 ; Pin 14
0000             40   
0000             41   DEC_BUTTON           EQU P0.5 ; Pin 1
0000             42   HOURS_BUTTON         EQU P3.0 ; Pin 5
0000             43   MINUTES_BUTTON       EQU P1.6 ; Pin 8
0000             44   SECONDS_BUTTON       EQU P1.5 ; Pin 10
0000             45   
0000             46   ALARM_OUT            EQU P1.7 ; Pin 6
0000             47   
0000             48   ;-------------------;
0000             49   ; Interrupt Vectors ;
0000             50   ;-------------------;
0000             51   ; Reset Vector
0000             52   ORG 0X0000
0000 0201C2      53       LJMP Main
0003             54   
0003             55   ; External Interrupt 0 Vector (Not Used)
0003             56   ORG 0X0003
0003 32          57            RETI
0004             58   
0004             59   ; Timer/Counter 0 Overflow Interrupt Vector
000B             60   ORG 0X000B
000B 020136      61            LJMP Timer0_ISR
000E             62   
000E             63   ; External Interrupt 1 vector (Not Used)
0013             64   ORG 0X0013
0013 32          65            RETI
0014             66   
0014             67   ; Timer/Counter 1 Overflow Interrupt Vector (Not Used)
001B             68   ORG 0X001B
001B 32          69            RETI
001C             70   
001C             71   ; Serial Port Receive/Transmit Interrupt Vector (Not Used)
0023             72   ORG 0X0023
0023 32          73            RETI
0024             74   
0024             75   ; Timer/Counter 2 Overflow Interrupt Vector
002B             76   ORG 0X002B
002B 020176      77            LJMP Timer2_ISR
002E             78   
002E             79   ; Note : Can Define Direct Access Variables Starting at 0X30 up to 0X7F in 8051.
0030             80   DSEG AT 0X30
0030             81   
0030             82   Counter_1ms:       DS 2 ; Used to Determine When 1000ms has Passed
0032             83   
0032             84   BCD_Time_Hours: DS 1
0033             85   BCD_Time_Minutes:  DS 1
0034             86   BCD_Time_Seconds:  DS 1
0035             87   
0035             88   BCD_Alarm_Hours: DS 1
0036             89   BCD_Alarm_Minutes: DS 1
0037             90   
0000             91   BSEG
0000             92   
0000             93   One_Second_Flag: DBIT 1 ; Set Bit In ISR After Every 1000ms
0001             94   
0001             95   Init_Time_Flag: DBIT 1 ; Set Bit When Time is Being Initialized
0002             96   Dec_En_Flag: DBIT 1 ; Set Bit When Decrement Button is Toggled
0003             97   
0003             98   Alarm_En_Flag:   DBIT 1
0004             99   Alarm_On_Flag:   DBIT 1
0005            100   
0005            101   Time_PM_Flag:    DBIT 1 ; Set Bit When Time is in PM
0006            102   Alarm_PM_Flag:   DBIT 1 ; Set Bit When Alarm is in PM
0007            103   Hour_Format_Flag:    DBIT 1 ; Set Bit When Time is in 24-Hour Mode
0008            104   
002E            105   CSEG
002E            106   
002E            107   LCD_RS EQU P1.3 ; Pin 12
002E            108   LCD_E  EQU P1.4 ; Pin 11
002E            109   LCD_D4 EQU P0.0 ; Pin 16
002E            110   LCD_D5 EQU P0.1 ; Pin 17
002E            111   LCD_D6 EQU P0.2 ; Pin 18
002E            112   LCD_D7 EQU P0.3 ; Pin 19
002E            113   
                115   	$LIST
00E2            117   
00E2 54494D45   118   TIME_INIT_MSG:     DB 'TIME xx:xx:xxxx', 0, 0
     2078783A
     78783A78
     78787800
     00
00F3 414C4152   119   ALARM_INIT_MSG:    DB 'ALARM xx:xxxx', 0
     4D207878
     3A787878
     7800
0101 414C4152   120   ALARM_UPDATE_MSG:  DB 'ALARM', 0
     4D00
0107            121   
0107 414D00     122   AM_MSG: DB 'AM', 0
010A 504D00     123   PM_MSG: DB 'PM', 0
010D            124   
010D 20202020   125   BLANK_DISPLAY: DB '                ', 0
     20202020
     20202020
     20202020
     00
011E 3A00       126   COLON: DB ':', 0
0120            127   
0120            128   ;---------------------------------------;
0120            129   ; Routine to Initialize ISR for Timer 0 ;
0120            130   ;---------------------------------------;
0120            131   Timer0_Init:
0120 438E08     132            ORL CKCON, #0B0000_1000 ; Input for Timer 0 is SYSCLK/1.
0123            133   
0123 E589       134            MOV A, TMOD
0125 54F0       135            ANL A, #0XF0 ; 1111_0000 Clear Bits for Timer 0
0127 4401       136            ORL A, #0X01 ; 0000_0001 Configure Timer 0 as 16-Timer
0129 F589       137            MOV TMOD, A
012B            138   
012B 758CF0     139            MOV TH0, #HIGH(TIMER0_RELOAD)
012E 758A2C     140            MOV TL0, #LOW(TIMER0_RELOAD)
0131            141   
0131            142            ; Enable Timer and Interrupts
0131 D2A9       143       SETB ET0  ; Enable Timer 0 Interrupt
0133 D28C       144            SETB TR0  ; Start Timer 0
0135 22         145            RET
0136            146   
0136            147   ;---------------------------------;
0136            148   ; ISR for Timer 0. Set to Execute ;
0136            149   ; Every 1/4096Hz to Generate a    ;
0136            150   ; 2048 Hz Wave at Pin ALARM_OUT   ;
0136            151   ;---------------------------------;
0136            152   Timer0_ISR:
0136            153            ; Save Registers to Stack.
0136 C0E0       154       PUSH ACC
0138 C0D0       155            PUSH PSW
013A            156   
013A 300311     157            JNB Alarm_En_Flag, No_Sound
013D 30040E     158            JNB Alarm_On_Flag, No_Sound
0140            159   Generate_Sound:
0140 C28C       160            CLR TR0 ; Stop Timer 0.
0142            161            ; Timer 0 Doesn't Have 16-Bit Auto-Reload.
0142 758CF0     162            MOV TH0, #HIGH(TIMER0_RELOAD)
0145 758A2C     163            MOV TL0, #LOW(TIMER0_RELOAD)
0148 D28C       164            SETB TR0
014A            165   
014A B297       166            CPL ALARM_OUT ; Toggle the Alarm Out Pin
014C 8006       167            SJMP Timer0_ISR_Done
014E            168   No_Sound:
014E            169            ; Timer 0 Doesn't Have 16-Bit Auto-Reload.
014E 758CF0     170            MOV TH0, #HIGH(TIMER0_RELOAD)
0151 758A2C     171            MOV TL0, #LOW(TIMER0_RELOAD)
0154            172   Timer0_ISR_Done:
0154            173            ; Restore Registers from Stack.
0154 D0D0       174            POP PSW
0156 D0E0       175            POP ACC
0158            176   
0158 32         177            RETI
0159            178   
0159            179   ;---------------------------------------;
0159            180   ; Routine to Initialize ISR for Timer 2 ;
0159            181   ;---------------------------------------;
0159            182   Timer2_Init:
0159 75C800     183            MOV T2CON, #0 ; Stop Timer. Autoreload Mode.
015C            184   
015C 75CDBF     185            MOV TH2, #HIGH(TIMER2_RELOAD)
015F 75CC28     186            MOV TL2, #LOW(TIMER2_RELOAD)
0162            187   
0162            188            ; Set Reload Value
0162 43C980     189            ORL T2MOD, #0X80 ; Enable Timer 2 Autoreload Mode
0165 75CBBF     190            MOV RCMP2H, #HIGH(TIMER2_RELOAD)
0168 75CA28     191            MOV RCMP2L, #LOW(TIMER2_RELOAD)
016B            192   
016B            193            ; Init 1ms Interrupt Counter. 16-bit Variable with Two 8-bit Parts.
016B E4         194            CLR A
016C F530       195            MOV Counter_1ms+0, A
016E F531       196            MOV Counter_1ms+1, A
0170            197   
0170            198            ; Enable the Timer and Interrupts.
0170 439B80     199            ORL EIE, #0X80 ; Enable Timer 2 Interrupt ET2=1
0173 D2CA       200       SETB TR2  ; Enable Timer 2
0175 22         201            RET
0176            202   
0176            203   ;-----------------;
0176            204   ; ISR for Timer 2 ;
0176            205   ;-----------------;
0176            206   Timer2_ISR:
0176 C2CF       207            CLR TF2  ; Timer 2 Doesn't Clear TF2 Automatically. Do it in the ISR.  It is Bit Addressable.
0178 B284       208            CPL P0.4 ; Interrupt Rate with Oscilloscope Must Precisely Be A 1ms Pulse.
017A            209   
017A            210            ; Save Registers to Stack
017A C0E0       211            PUSH ACC
017C C0D0       212            PUSH PSW
017E            213   
017E            214            ; Increment 16-bit 1ms Counter.
017E 0530       215            INC Counter_1ms+0 ; Increment Low 8-bits
0180 E530       216            MOV A, Counter_1ms+0 ; Increment High 8-bits if Lower 8-bits Overflow
0182 7002       217            JNZ Update_BCD
0184 0531       218            INC Counter_1ms+1
0186            219   Update_BCD:
0186            220            ; Check if 1000ms Have Passed
0186 E530       221            MOV A, Counter_1ms+0
0188 B4E832     222            CJNE A, #LOW(1000), Timer2_ISR_Done ; Note : Changes Carry Flag
018B E531       223            MOV A, Counter_1ms+1
018D B4032D     224            CJNE A, #HIGH(1000), Timer2_ISR_Done
0190            225   
0190            226            ; 1000ms Have Passed. Set Flag to Inform Main Program.
0190 D200       227            SETB One_Second_Flag
0192            228   Check_Alarm:
0192 30031E     229            JNB Alarm_En_Flag, No_Alarm
0195            230   
0195            231            ; Check if Time Hours Equals Alarm Hours
0195 E532       232            MOV A, BCD_Time_Hours
0197 B53519     233            CJNE A, BCD_Alarm_Hours, No_Alarm
019A            234   
019A            235            ; Check if Time Minutes Equals Alarm Minutes
019A E533       236            MOV A, BCD_Time_Minutes
019C B53614     237            CJNE A, BCD_Alarm_Minutes, No_Alarm
019F            238   
019F            239            ; Check AM/PM Flag
019F E4         240            CLR A
01A0 F5F0       241            MOV B, A
01A2 A205       242            MOV C, Time_PM_Flag
01A4 92F0       243            MOV B.0, C
01A6 A206       244            MOV C, Alarm_PM_Flag
01A8 92E0       245            MOV ACC.0, C
01AA B5F006     246            CJNE A, B, No_Alarm
01AD            247   BEEP:
01AD D204       248            SETB Alarm_On_Flag
01AF B28C       249            CPL TR0 ; Create Beep-Silence-Beep-Silence Sounds
01B1 8002       250            SJMP Continue_ISR
01B3            251   No_Alarm:
01B3 C204       252            CLR Alarm_On_Flag
01B5            253   Continue_ISR:
01B5            254            ; Reset 1ms Counter to 0.
01B5 E4         255            CLR A
01B6 F530       256            MOV Counter_1ms+0, A
01B8 F531       257            MOV Counter_1ms+1, A
01BA 12057F     258            LCALL Update_Time_Seconds
01BD            259   Timer2_ISR_Done:
01BD D0D0       260            POP PSW
01BF D0E0       261            POP ACC
01C1 32         262            RETI
01C2            263   
01C2            264   ;----------------------------------;
01C2            265   ; Main Program. Includes Hardware  ;
01C2            266   ; Initialization and Forever Loop. ;
01C2            267   ;----------------------------------;
01C2            268   Main:
01C2            269            ; Initialization
01C2 75817F     270       MOV SP, #0X7F
01C5 75B100     271       MOV P0M1, #0X00
01C8 75B200     272       MOV P0M2, #0X00
01CB 75B300     273       MOV P1M1, #0X00
01CE 75B400     274       MOV P1M2, #0X00
01D1 75AD00     275       MOV P3M2, #0X00
01D4 75AD00     276       MOV P3M2, #0X00
01D7            277   
01D7 120120     278       LCALL Timer0_Init
01DA 120159     279       LCALL Timer2_Init
01DD D2AF       280       SETB EA   ; Enable Global Interrupts
01DF 120087     281       LCALL LCD_4BIT
01E2            282   
01E2            283   Init_Time:
01E2 D201       284            SETB Init_Time_Flag
01E4 D200       285       SETB One_Second_Flag
01E6 C205       286            CLR Time_PM_Flag
01E8 C202       287            CLR Dec_En_Flag
01EA C207       288            CLR Hour_Format_Flag
01EC            289   
01EC C2CA       290            CLR TR2 ; Stop Timer 2
01EE            291   
01EE            292            ; Starting Display is 8:00:00 AM
01EE 7408       293            MOV A, #0X08
01F0 F532       294            MOV BCD_Time_Hours, A
01F2            295   
01F2 7400       296            MOV A, #0X00
01F4 F533       297            MOV BCD_Time_Minutes, A
01F6            298   
01F6 7400       299            MOV A, #0X00
01F8 F534       300            MOV BCD_Time_Seconds, A
01FA            301   
01FA C0E0       302            push acc
01FC 7401       302            mov a, #1
01FE 14         302            dec a
01FF 1200C7     302            lcall ?Set_Cursor_1 ; Select column and row
0202 D0E0       302            pop acc
0204 C083       303            push dph
0206 C082       303            push dpl
0208 C0E0       303            push acc
020A 9000E2     303            mov dptr, #TIME_INIT_MSG
020D 1200BA     303            lcall ?Send_Constant_String
0210 D0E0       303            pop acc
0212 D082       303            pop dpl
0214 D083       303            pop dph
0216            304   Check_Set_Time:
0216 209012     305            JB SET_BUTTON, Init_Time_Display
0219 C002       306            push AR2
021B 7A32       306            mov R2, #50
021D 120038     306            lcall ?Wait_Milli_Seconds
0220 D002       306            pop AR2
0222 209006     307            JB SET_BUTTON, Init_Time_Display
0225 3090FD     308            JNB SET_BUTTON, $ ; Wait for Rising Edge
0228 020276     309            LJMP Init_Time_End
022B            310   Init_Time_Display:
022B 120644     311            LCALL Check_Hour_Format
022E 1202D3     312            LCALL Update_Time_Display
0231 12062F     313            LCALL Check_Dec_En
0234            314   Init_Time_Seconds:
0234 209512     315            JB SECONDS_BUTTON, Init_Time_Minutes
0237 C002       316            push AR2
0239 7A32       316            mov R2, #50
023B 120038     316            lcall ?Wait_Milli_Seconds
023E D002       316            pop AR2
0240 209506     317            JB SECONDS_BUTTON, Init_Time_Minutes
0243 3095FD     318            JNB SECONDS_BUTTON, $ ; Wait for Rising Edge
0246 12057F     319            LCALL Update_Time_Seconds
0249            320   Init_Time_Minutes:
0249 209612     321            JB MINUTES_BUTTON, Init_Time_Hours
024C C002       322            push AR2
024E 7A32       322            mov R2, #50
0250 120038     322            lcall ?Wait_Milli_Seconds
0253 D002       322            pop AR2
0255 209606     323            JB MINUTES_BUTTON, Init_Time_Hours
0258 3096FD     324            JNB MINUTES_BUTTON, $ ; Wait for Rising Edge
025B 12054E     325            LCALL Update_Time_Minutes
025E            326   Init_Time_Hours:
025E 20B012     327            JB HOURS_BUTTON, Init_Time_Loop
0261 C002       328            push AR2
0263 7A32       328            mov R2, #50
0265 120038     328            lcall ?Wait_Milli_Seconds
0268 D002       328            pop AR2
026A 20B006     329            JB HOURS_BUTTON, Init_Time_Loop
026D 30B0FD     330            JNB HOURS_BUTTON, $ ; Wait for Rising Edge
0270 120511     331            LCALL Update_Time_Hours
0273            332   Init_Time_Loop:
0273 020216     333            LJMP Check_Set_Time
0276            334   Init_Time_End:
0276 D2CA       335            SETB TR2 ; Set Timer 2
0278 C201       336            CLR Init_Time_Flag
027A            337   Init_Alarm:
027A D203       338            SETB Alarm_En_Flag
027C C204       339            CLR Alarm_On_Flag
027E            340   
027E            341            ; Starting Alarm is 06:00 AM
027E C206       342            CLR Alarm_PM_Flag
0280 7406       343            MOV A, #0X06
0282 F535       344            MOV BCD_Alarm_Hours, A
0284            345   
0284 7400       346            MOV A, #0X00
0286 F536       347            MOV BCD_Alarm_Minutes, A
0288            348   
0288 0202C5     349            LJMP Update_LCD_Display
028B            350   
028B            351   ;------------------------------------------------------;
028B            352   ; Forever Loop to Check Buttons and Update LCD Display ;
028B            353   ;------------------------------------------------------;
028B            354   Check_Buttons:
028B 8000       355            SJMP Check_Update_Alarm
028D            356   Check_Update_Alarm:
028D 12061A     357            LCALL Check_Alarm_En
0290 12062F     358            LCALL Check_Dec_En
0293 200303     359            JB Alarm_En_Flag, Check_Update_Alarm_Minutes
0296 0202C5     360            LJMP Update_LCD_Display
0299            361   Check_Update_Alarm_Minutes:
0299 209612     362            JB MINUTES_BUTTON, Check_Update_Alarm_Hours
029C C002       363            push AR2
029E 7A32       363            mov R2, #50
02A0 120038     363            lcall ?Wait_Milli_Seconds
02A3 D002       363            pop AR2
02A5 209606     364            JB MINUTES_BUTTON, Check_Update_Alarm_Hours
02A8 3096FD     365            JNB MINUTES_BUTTON, $ ; Wait for Rising Edge
02AB 1205EC     366            LCALL Update_Alarm_Minutes ; Increment Alarm Minutes
02AE            367   Check_Update_Alarm_Hours:
02AE 20B014     368            JB HOURS_BUTTON, Update_LCD_Display
02B1 C002       369            push AR2
02B3 7A32       369            mov R2, #50
02B5 120038     369            lcall ?Wait_Milli_Seconds
02B8 D002       369            pop AR2
02BA 20B008     370            JB HOURS_BUTTON, Update_LCD_Display
02BD 30B0FD     371            JNB HOURS_BUTTON, $ ; Wait for Rising Edge
02C0 1205B0     372            LCALL Update_Alarm_Hours ; Increment Alarm Hours
02C3 8000       373            SJMP Update_LCD_Display
02C5            374   Update_LCD_Display:
02C5 C200       375       CLR One_Second_Flag
02C7 120644     376            LCALL Check_Hour_Format
02CA 1202D3     377            LCALL Update_Time_Display
02CD 1203CD     378            LCALL Update_Alarm_Display
02D0 02028B     379            LJMP Check_Buttons
02D3            380   
02D3            381   ;--------------------;
02D3            382   ; Update LCD Display ;
02D3            383   ;--------------------;
02D3            384   Update_Time_Display:
02D3            385            ; Display Time
02D3 C0E0       386            push acc
02D5 7409       386            mov a, #9
02D7 14         386            dec a
02D8 1200C7     386            lcall ?Set_Cursor_1 ; Select column and row
02DB D0E0       386            pop acc
02DD C000       387            push ar0
02DF A833       387            mov r0, BCD_Time_Minutes
02E1 1200CC     387            lcall ?Display_BCD
02E4 D000       387            pop ar0
02E6 C0E0       388            push acc
02E8 740C       388            mov a, #12
02EA 14         388            dec a
02EB 1200C7     388            lcall ?Set_Cursor_1 ; Select column and row
02EE D0E0       388            pop acc
02F0 C000       389            push ar0
02F2 A834       389            mov r0, BCD_Time_Seconds
02F4 1200CC     389            lcall ?Display_BCD
02F7 D000       389            pop ar0
02F9            390   
02F9 200755     391            JB Hour_Format_Flag, Update_Time_Hours_24
02FC 8000       392            SJMP Update_Time_Hours_12
02FE            393   Update_Time_Hours_12:
02FE C0E0       394            push acc
0300 7406       394            mov a, #6
0302 14         394            dec a
0303 1200C7     394            lcall ?Set_Cursor_1 ; Select column and row
0306 D0E0       394            pop acc
0308 C000       395            push ar0
030A A832       395            mov r0, BCD_Time_Hours
030C 1200CC     395            lcall ?Display_BCD
030F D000       395            pop ar0
0311 20051E     396            JB Time_PM_Flag, Update_Time_PM
0314            397   Update_Time_AM:
0314 C0E0       398            push acc
0316 740E       398            mov a, #14
0318 14         398            dec a
0319 1200C7     398            lcall ?Set_Cursor_1 ; Select column and row
031C D0E0       398            pop acc
031E C083       399            push dph
0320 C082       399            push dpl
0322 C0E0       399            push acc
0324 900107     399            mov dptr, #AM_MSG
0327 1200BA     399            lcall ?Send_Constant_String
032A D0E0       399            pop acc
032C D082       399            pop dpl
032E D083       399            pop dph
0330 801E       400            SJMP Update_Time_Display_End
0332            401   Update_Time_PM:
0332 C0E0       402            push acc
0334 740E       402            mov a, #14
0336 14         402            dec a
0337 1200C7     402            lcall ?Set_Cursor_1 ; Select column and row
033A D0E0       402            pop acc
033C C083       403            push dph
033E C082       403            push dpl
0340 C0E0       403            push acc
0342 90010A     403            mov dptr, #PM_MSG
0345 1200BA     403            lcall ?Send_Constant_String
0348 D0E0       403            pop acc
034A D082       403            pop dpl
034C D083       403            pop dph
034E 8000       404            SJMP Update_Time_Display_End
0350            405   Update_Time_Display_End:
0350 22         406            RET
0351            407   
0351            408   Update_Time_Hours_24:
0351 C0E0       409            push acc
0353 740E       409            mov a, #14
0355 14         409            dec a
0356 1200C7     409            lcall ?Set_Cursor_1 ; Select column and row
0359 D0E0       409            pop acc
035B C083       410            push dph
035D C082       410            push dpl
035F C0E0       410            push acc
0361 90010D     410            mov dptr, #BLANK_DISPLAY
0364 1200BA     410            lcall ?Send_Constant_String
0367 D0E0       410            pop acc
0369 D082       410            pop dpl
036B D083       410            pop dph
036D E532       411            MOV A, BCD_Time_Hours
036F 20052C     412            JB Time_PM_Flag, Update_Time_Hours_24_PM
0372            413   Update_Time_Hours_24_AM:
0372 C0E0       414            push acc
0374 7406       414            mov a, #6
0376 14         414            dec a
0377 1200C7     414            lcall ?Set_Cursor_1 ; Select column and row
037A D0E0       414            pop acc
037C C000       415            push ar0
037E F8         415            mov r0, A
037F 1200CC     415            lcall ?Display_BCD
0382 D000       415            pop ar0
0384 B412C9     416            CJNE A, #0X12, Update_Time_Display_End
0387 8000       417            SJMP Update_Time_0000
0389            418   Update_Time_0000:
0389 C0E0       419            push acc
038B 7406       419            mov a, #6
038D 14         419            dec a
038E 1200C7     419            lcall ?Set_Cursor_1 ; Select column and row
0391 D0E0       419            pop acc
0393 C000       420            push ar0
0395 7800       420            mov r0, #0X00
0397 1200CC     420            lcall ?Display_BCD
039A D000       420            pop ar0
039C 80B2       421            SJMP Update_Time_Display_End
039E            422   Update_Time_Hours_24_PM:
039E C0E0       423            push acc
03A0 7406       423            mov a, #6
03A2 14         423            dec a
03A3 1200C7     423            lcall ?Set_Cursor_1 ; Select column and row
03A6 D0E0       423            pop acc
03A8 240C       424            ADD A, #12
03AA D4         425            DA A
03AB C000       426            push ar0
03AD F8         426            mov r0, A
03AE 1200CC     426            lcall ?Display_BCD
03B1 D000       426            pop ar0
03B3 B4249A     427            CJNE A, #0X24, Update_Time_Display_End
03B6 8000       428            SJMP Update_Time_1200
03B8            429   Update_Time_1200:
03B8 C0E0       430            push acc
03BA 7406       430            mov a, #6
03BC 14         430            dec a
03BD 1200C7     430            lcall ?Set_Cursor_1 ; Select column and row
03C0 D0E0       430            pop acc
03C2 C000       431            push ar0
03C4 7812       431            mov r0, #0X12
03C6 1200CC     431            lcall ?Display_BCD
03C9 D000       431            pop ar0
03CB 8083       432            SJMP Update_Time_Display_End
03CD            433   
03CD            434   
03CD            435   Update_Alarm_Display:
03CD 200303     436            JB Alarm_En_Flag, Update_Alarm_En_On
03D0 0204F2     437            LJMP Update_Alarm_En_Off
03D3            438   Update_Alarm_En_On:
03D3            439            ; Display Alarm
03D3 C0E0       440            push acc
03D5 7401       440            mov a, #1
03D7 14         440            dec a
03D8 1200C5     440            lcall ?Set_Cursor_2 ; Select column and row
03DB D0E0       440            pop acc
03DD C083       441            push dph
03DF C082       441            push dpl
03E1 C0E0       441            push acc
03E3 900101     441            mov dptr, #ALARM_UPDATE_MSG
03E6 1200BA     441            lcall ?Send_Constant_String
03E9 D0E0       441            pop acc
03EB D082       441            pop dpl
03ED D083       441            pop dph
03EF C0E0       442            push acc
03F1 7409       442            mov a, #9
03F3 14         442            dec a
03F4 1200C5     442            lcall ?Set_Cursor_2 ; Select column and row
03F7 D0E0       442            pop acc
03F9 C083       443            push dph
03FB C082       443            push dpl
03FD C0E0       443            push acc
03FF 90011E     443            mov dptr, #COLON
0402 1200BA     443            lcall ?Send_Constant_String
0405 D0E0       443            pop acc
0407 D082       443            pop dpl
0409 D083       443            pop dph
040B            443   
040B C0E0       444            push acc
040D 740A       444            mov a, #10
040F 14         444            dec a
0410 1200C5     444            lcall ?Set_Cursor_2 ; Select column and row
0413 D0E0       444            pop acc
0415 C000       445            push ar0
0417 A836       445            mov r0, BCD_Alarm_Minutes
0419 1200CC     445            lcall ?Display_BCD
041C D000       445            pop ar0
041E            446   
041E 200755     447            JB Hour_Format_Flag, Update_Alarm_Hours_24
0421 8000       448            SJMP Update_Alarm_Hours_12
0423            449   Update_Alarm_Hours_12:
0423 C0E0       450            push acc
0425 7407       450            mov a, #7
0427 14         450            dec a
0428 1200C5     450            lcall ?Set_Cursor_2 ; Select column and row
042B D0E0       450            pop acc
042D C000       451            push ar0
042F A835       451            mov r0, BCD_Alarm_Hours
0431 1200CC     451            lcall ?Display_BCD
0434 D000       451            pop ar0
0436 20061E     452            JB Alarm_PM_Flag, Update_Alarm_PM
0439            453   Update_Alarm_AM:
0439 C0E0       454            push acc
043B 740C       454            mov a, #12
043D 14         454            dec a
043E 1200C5     454            lcall ?Set_Cursor_2 ; Select column and row
0441 D0E0       454            pop acc
0443 C083       455            push dph
0445 C082       455            push dpl
0447 C0E0       455            push acc
0449 900107     455            mov dptr, #AM_MSG
044C 1200BA     455            lcall ?Send_Constant_String
044F D0E0       455            pop acc
0451 D082       455            pop dpl
0453 D083       455            pop dph
0455 801E       456       SJMP Update_Alarm_Display_End
0457            457   Update_Alarm_PM:
0457 C0E0       458            push acc
0459 740C       458            mov a, #12
045B 14         458            dec a
045C 1200C5     458            lcall ?Set_Cursor_2 ; Select column and row
045F D0E0       458            pop acc
0461 C083       459            push dph
0463 C082       459            push dpl
0465 C0E0       459            push acc
0467 90010A     459            mov dptr, #PM_MSG
046A 1200BA     459            lcall ?Send_Constant_String
046D D0E0       459            pop acc
046F D082       459            pop dpl
0471 D083       459            pop dph
0473 8000       460       SJMP Update_Alarm_Display_End
0475            461   Update_Alarm_Display_End:
0475 22         462            RET
0476            463   
0476            464   Update_Alarm_Hours_24:
0476 C0E0       465            push acc
0478 740C       465            mov a, #12
047A 14         465            dec a
047B 1200C5     465            lcall ?Set_Cursor_2 ; Select column and row
047E D0E0       465            pop acc
0480 C083       466            push dph
0482 C082       466            push dpl
0484 C0E0       466            push acc
0486 90010D     466            mov dptr, #BLANK_DISPLAY
0489 1200BA     466            lcall ?Send_Constant_String
048C D0E0       466            pop acc
048E D082       466            pop dpl
0490 D083       466            pop dph
0492 E535       467            MOV A, BCD_Alarm_Hours
0494 20062C     468            JB Alarm_PM_Flag, Update_Alarm_Hours_24_PM
0497            469   Update_Alarm_Hours_24_AM:
0497 C0E0       470            push acc
0499 7407       470            mov a, #7
049B 14         470            dec a
049C 1200C5     470            lcall ?Set_Cursor_2 ; Select column and row
049F D0E0       470            pop acc
04A1 C000       471            push ar0
04A3 F8         471            mov r0, A
04A4 1200CC     471            lcall ?Display_BCD
04A7 D000       471            pop ar0
04A9 B412C9     472            CJNE A, #0X12, Update_Alarm_Display_End
04AC 8000       473            SJMP Update_Alarm_0000
04AE            474   Update_Alarm_0000:
04AE C0E0       475            push acc
04B0 7407       475            mov a, #7
04B2 14         475            dec a
04B3 1200C5     475            lcall ?Set_Cursor_2 ; Select column and row
04B6 D0E0       475            pop acc
04B8 C000       476            push ar0
04BA 7800       476            mov r0, #0X00
04BC 1200CC     476            lcall ?Display_BCD
04BF D000       476            pop ar0
04C1 80B2       477            SJMP Update_Alarm_Display_End
04C3            478   Update_Alarm_Hours_24_PM:
04C3 C0E0       479            push acc
04C5 7407       479            mov a, #7
04C7 14         479            dec a
04C8 1200C5     479            lcall ?Set_Cursor_2 ; Select column and row
04CB D0E0       479            pop acc
04CD 240C       480            ADD A, #12
04CF D4         481            DA A
04D0 C000       482            push ar0
04D2 F8         482            mov r0, A
04D3 1200CC     482            lcall ?Display_BCD
04D6 D000       482            pop ar0
04D8 B4249A     483            CJNE A, #0X24, Update_Alarm_Display_End
04DB 8000       484            SJMP Update_Alarm_1200
04DD            485   Update_Alarm_1200:
04DD C0E0       486            push acc
04DF 7407       486            mov a, #7
04E1 14         486            dec a
04E2 1200C5     486            lcall ?Set_Cursor_2 ; Select column and row
04E5 D0E0       486            pop acc
04E7 C000       487            push ar0
04E9 7812       487            mov r0, #0X12
04EB 1200CC     487            lcall ?Display_BCD
04EE D000       487            pop ar0
04F0 8083       488            SJMP Update_Alarm_Display_End
04F2            489   
04F2            490   Update_Alarm_En_Off:
04F2 C0E0       491            push acc
04F4 7401       491            mov a, #1
04F6 14         491            dec a
04F7 1200C5     491            lcall ?Set_Cursor_2 ; Select column and row
04FA D0E0       491            pop acc
04FC C083       492            push dph
04FE C082       492            push dpl
0500 C0E0       492            push acc
0502 90010D     492            mov dptr, #BLANK_DISPLAY
0505 1200BA     492            lcall ?Send_Constant_String
0508 D0E0       492            pop acc
050A D082       492            pop dpl
050C D083       492            pop dph
050E 020475     493            LJMP Update_Alarm_Display_End
0511            494   
0511            495   ;-------------------------------;
0511            496   ; Update Time on LCD Display ;
0511            497   ;-------------------------------;
0511            498   Update_Time_Hours:
0511 300106     499            JNB Init_Time_Flag, Inc_Time_Hours
0514 300203     500            JNB Dec_En_Flag, Inc_Time_Hours
0517 020536     501            LJMP Dec_Time_Hours
051A            502   
051A            503   Inc_Time_Hours:
051A E532       504            MOV A, BCD_Time_Hours
051C 2401       505            ADD A, #1
051E D4         506            DA A
051F F532       507            MOV BCD_Time_Hours, A
0521 9412       508            SUBB A, #0X12
0523 4010       509            JC Update_Time_Hours_Done
0525 7007       510            JNZ Offset_Time_Hours
0527            511   Toggle_Time_AMPM:
0527 753212     512            MOV BCD_Time_Hours, #0X12
052A B205       513            CPL Time_PM_Flag
052C 8007       514            SJMP Update_Time_Hours_Done
052E            515   Offset_Time_Hours:
052E E532       516            MOV A, BCD_Time_Hours
0530 9412       517            SUBB A, #0X12
0532 D4         518            DA A
0533 F532       519            MOV BCD_Time_Hours, A
0535            520   Update_Time_Hours_Done:
0535 22         521            RET
0536            522   
0536            523   Dec_Time_Hours:
0536 E532       524            MOV A, BCD_Time_Hours
0538 B41207     525            CJNE A, #0X12, Dec_Time_Hours_Continued
053B            526   Rewind_Time_AMPM:
053B 753211     527            MOV BCD_Time_Hours, #0X11
053E B205       528            CPL Time_PM_Flag
0540 80F3       529            SJMP Update_Time_Hours_Done
0542            530   Dec_Time_Hours_Continued:
0542 2499       531            ADD A, #0X99 ; Adding 10-Complement of -1
0544 D4         532            DA A
0545 F532       533            MOV BCD_Time_Hours, A
0547 70EC       534            JNZ Update_Time_Hours_Done
0549            535   Rewind_Time_Hours:
0549 753212     536            MOV BCD_Time_Hours, #0X12
054C 80E7       537            SJMP Update_Time_Hours_Done
054E            538   
054E            539   
054E            540   Update_Time_Minutes:
054E 300106     541            JNB Init_Time_Flag, Inc_Time_Minutes
0551 300203     542            JNB Dec_En_Flag, Inc_Time_Minutes
0554 02056C     543            LJMP Dec_Time_Minutes
0557            544   
0557            545   Inc_Time_Minutes:
0557 E533       546            MOV A, BCD_Time_Minutes
0559 2401       547            ADD A, #1
055B D4         548            DA A
055C F533       549            MOV BCD_Time_Minutes, A
055E B4600A     550            CJNE A, #0X60, Update_Time_Minutes_Done
0561 8000       551            SJMP Reset_Time_Minutes
0563            552   Reset_Time_Minutes:
0563 753300     553            MOV BCD_Time_Minutes, #0X00
0566 120511     554            LCALL Update_Time_Hours
0569 8000       555            SJMP Update_Time_Minutes_Done
056B            556   Update_Time_Minutes_Done:
056B 22         557            RET
056C            558   
056C            559   Dec_Time_Minutes:
056C E533       560            MOV A, BCD_Time_Minutes
056E 7008       561            JNZ Dec_Time_Minutes_Continued
0570            562   Rewind_Time_Minutes:
0570 753359     563            MOV BCD_Time_Minutes, #0X59
0573 120511     564            LCALL Update_Time_Hours
0576 80F3       565            SJMP Update_Time_Minutes_Done
0578            566   Dec_Time_Minutes_Continued:
0578 2499       567            ADD A, #0X99 ; Adding 10-Complement of -1
057A D4         568            DA A
057B F533       569            MOV BCD_Time_Minutes, A
057D 80EC       570            SJMP Update_Time_Minutes_Done
057F            571   
057F            572   Update_Time_Seconds:
057F 300106     573            JNB Init_Time_Flag, Inc_Time_Seconds
0582 300203     574            JNB Dec_En_Flag, Inc_Time_Seconds
0585 02059D     575            LJMP Dec_Time_Seconds
0588            576   
0588            577   Inc_Time_Seconds:
0588 E534       578            MOV A, BCD_Time_Seconds
058A 2401       579            ADD A, #1
058C D4         580            DA A
058D F534       581            MOV BCD_Time_Seconds, A
058F B4600A     582            CJNE A, #0X60, Update_Time_Seconds_Done
0592 8000       583            SJMP Reset_Time_Seconds
0594            584   Reset_Time_Seconds:
0594 753400     585            MOV BCD_Time_Seconds, #0X00
0597 12054E     586            LCALL Update_Time_Minutes
059A 8000       587            SJMP Update_Time_Seconds_Done
059C            588   Update_Time_Seconds_Done:
059C 22         589            RET
059D            590   
059D            591   Dec_Time_Seconds:
059D E534       592            MOV A, BCD_Time_Seconds
059F 7008       593            JNZ Dec_Time_Seconds_Continued
05A1            594   Rewind_Time_Seconds:
05A1 753459     595            MOV BCD_Time_Seconds, #0X59
05A4 12054E     596            LCALL Update_Time_Minutes
05A7 80F3       597            SJMP Update_Time_Seconds_Done
05A9            598   Dec_Time_Seconds_Continued:
05A9 2499       599            ADD A, #0X99 ; Adding 10-Complement of -1
05AB D4         600            DA A
05AC F534       601            MOV BCD_Time_Seconds, A
05AE 80EC       602            SJMP Update_Time_Seconds_Done
05B0            603   
05B0            604   Update_Alarm_Hours:
05B0 300203     605            JNB Dec_En_Flag, Inc_Alarm_Hours
05B3 0205D4     606            LJMP Dec_Alarm_Hours
05B6            607   
05B6            608   Inc_Alarm_Hours:
05B6 E535       609            MOV A, BCD_Alarm_Hours
05B8 2401       610            ADD A, #1
05BA D4         611            DA A
05BB F535       612            MOV BCD_Alarm_Hours, A
05BD 9412       613            SUBB A, #0X12
05BF 4012       614            JC Update_Alarm_Hours_Done
05C1 7007       615            JNZ Offset_Alarm_Hours
05C3            616   Toggle_Alarm_AMPM:
05C3 753512     617            MOV BCD_Alarm_Hours, #0X12
05C6 B206       618            CPL Alarm_PM_Flag
05C8 8009       619            SJMP Update_Alarm_Hours_Done
05CA            620   Offset_Alarm_Hours:
05CA E535       621            MOV A, BCD_Alarm_Hours
05CC 9412       622            SUBB A, #0X12
05CE D4         623            DA A
05CF F535       624            MOV BCD_Alarm_Hours, A
05D1 8000       625            SJMP Update_Alarm_Hours_Done
05D3            626   Update_Alarm_Hours_Done:
05D3 22         627            RET
05D4            628   
05D4            629   Dec_Alarm_Hours:
05D4 E535       630            MOV A, BCD_Alarm_Hours
05D6 B41207     631            CJNE A, #0X12, Dec_Alarm_Hours_Continued
05D9            632   Rewind_Alarm_AMPM:
05D9 753511     633            MOV BCD_Alarm_Hours, #0X11
05DC B206       634            CPL Alarm_PM_Flag
05DE 80F3       635            SJMP Update_Alarm_Hours_Done
05E0            636   Dec_Alarm_Hours_Continued:
05E0 2499       637            ADD A, #0X99 ; Adding 10-Complement of -1
05E2 D4         638            DA A
05E3 F535       639            MOV BCD_Alarm_Hours, A
05E5 70EC       640            JNZ Update_Alarm_Hours_Done
05E7            641   Rewind_Alarm_Hours:
05E7 753512     642            MOV BCD_Alarm_Hours, #0X12
05EA 80E7       643            SJMP Update_Alarm_Hours_Done
05EC            644   
05EC            645   
05EC            646   Update_Alarm_Minutes:
05EC 300203     647            JNB Dec_En_Flag, Inc_Alarm_Minutes
05EF 020607     648            LJMP Dec_Alarm_Minutes
05F2            649   
05F2            650   Inc_Alarm_Minutes:
05F2 E536       651            MOV A, BCD_Alarm_Minutes
05F4 2401       652            ADD A, #1
05F6 D4         653            DA A
05F7 F536       654            MOV BCD_Alarm_Minutes, A
05F9 B4600A     655            CJNE A, #0X60, Update_Alarm_Minutes_Done
05FC 8000       656            SJMP Reset_Alarm_Minutes
05FE            657   Reset_Alarm_Minutes:
05FE 753600     658            MOV BCD_Alarm_Minutes, #0X00
0601 1205B0     659            LCALL Update_Alarm_Hours
0604 8000       660            SJMP Update_Alarm_Minutes_Done
0606            661   Update_Alarm_Minutes_Done:
0606 22         662            RET
0607            663   
0607            664   Dec_Alarm_Minutes:
0607 E536       665            MOV A, BCD_Alarm_Minutes
0609 7008       666            JNZ Dec_Alarm_Minutes_Continued
060B            667   Rewind_Alarm_Minutes:
060B 753659     668            MOV BCD_Alarm_Minutes, #0X59
060E 1205B0     669            LCALL Update_Alarm_Hours
0611 80F3       670            SJMP Update_Alarm_Minutes_Done
0613            671   Dec_Alarm_Minutes_Continued:
0613 2499       672            ADD A, #0X99 ; Adding 10-Complement of -1
0615 D4         673            DA A
0616 F536       674            MOV BCD_Alarm_Minutes, A
0618 80EC       675            SJMP Update_Alarm_Minutes_Done
061A            676   
061A            677   ;----------------;
061A            678   ; Enable/Disable ;
061A            679   ;----------------;
061A            680   Check_Alarm_En:
061A 209011     681            JB SET_BUTTON, Check_Alarm_En_Done
061D C002       682            push AR2
061F 7A32       682            mov R2, #50
0621 120038     682            lcall ?Wait_Milli_Seconds
0624 D002       682            pop AR2
0626 209005     683            JB SET_BUTTON, Check_Alarm_En_Done
0629 3090FD     684            JNB SET_BUTTON, $ ; Wait for Rising Edge
062C B203       685            CPL Alarm_En_Flag ; Toggle Alarm Enable Flag
062E            686   Check_Alarm_En_Done:
062E 22         687            RET
062F            688   
062F            689   Check_Dec_En:
062F 208511     690            JB DEC_BUTTON, Check_Dec_En_Done
0632 C002       691            push AR2
0634 7A32       691            mov R2, #50
0636 120038     691            lcall ?Wait_Milli_Seconds
0639 D002       691            pop AR2
063B 208505     692            JB DEC_BUTTON, Check_Dec_En_Done
063E 3085FD     693            JNB DEC_BUTTON, $ ; Wait for Rising Edge
0641 B202       694            CPL Dec_En_Flag
0643            695   Check_Dec_En_Done:
0643 22         696            RET
0644            697   
0644            698   Check_Hour_Format:
0644 209111     699            JB HOUR_FORMAT_BUTTON, Check_Hour_Format_Done
0647 C002       700            push AR2
0649 7A32       700            mov R2, #50
064B 120038     700            lcall ?Wait_Milli_Seconds
064E D002       700            pop AR2
0650 209105     701            JB HOUR_FORMAT_BUTTON, Check_Hour_Format_Done
0653 3091FD     702            JNB HOUR_FORMAT_BUTTON, $ ; Wait for Rising Edge
0656 B207       703            CPL Hour_Format_Flag
0658            704   Check_Hour_Format_Done:
0658 22         705            RET
0659            706   END
