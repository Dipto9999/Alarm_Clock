0000              1   ; Lab2_MuntakimRahman_71065221.asm:
0000              2   ;        A) Drives A 16x2 LCD Display Using 4-Bit Mode and Displays 12-Hour Clock Time
0000              3   ;   b) Generates A 2kHz Square Wave at Pin P1.7 Using an ISR For Timer 0.
0000              4   ;      Drives A Speaker When Alarm is Activated.
                  6   $LIST
0000              8   
0000              9   ;  N76E003 pinout:
0000             10   ;                               -------
0000             11   ;       PWM2/IC6/T0/AIN4/P0.5 -|1    20|- P0.4/AIN5/STADC/PWM3/IC3
0000             12   ;               TXD/AIN3/P0.6 -|2    19|- P0.3/PWM5/IC5/AIN6
0000             13   ;               RXD/AIN2/P0.7 -|3    18|- P0.2/ICPCK/OCDCK/RXD_1/[SCL]
0000             14   ;                    RST/P2.0 -|4    17|- P0.1/PWM4/IC4/MISO
0000             15   ;        INT0/OSCIN/AIN1/P3.0 -|5    16|- P0.0/PWM3/IC3/MOSI/T1
0000             16   ;              INT1/AIN0/P1.7 -|6    15|- P1.0/PWM2/IC2/SPCLK
0000             17   ;                         GND -|7    14|- P1.1/PWM1/IC1/AIN7/CLO
0000             18   ;[SDA]/TXD_1/ICPDA/OCDDA/P1.6 -|8    13|- P1.2/PWM0/IC0
0000             19   ;                         VDD -|9    12|- P1.3/SCL/[STADC]
0000             20   ;            PWM5/IC7/SS/P1.5 -|10   11|- P1.4/SDA/FB/PWM1
0000             21   ;                               -------
0000             22   ;
0000             23   
0000             24   ;-------------------;
0000             25   ; Clock FrEQUencies ;
0000             26   ;-------------------;
0000             27   CLK           EQU 16600000 ; Microcontroller System Frequency in Hz
0000             28   
0000             29   TIMER0_RATE   EQU 4096     ; 2048Hz Squarewave (Peak Amplitude of CEM-1203 Speaker)
0000             30   TIMER0_RELOAD EQU ((65536-(CLK/TIMER0_RATE)))
0000             31   
0000             32   TIMER2_RATE   EQU 1000     ; 1000Hz, for Timer Tick of 1ms
0000             33   TIMER2_RELOAD EQU ((65536-(CLK/TIMER2_RATE)))
0000             34   
0000             35   ;-----------------;
0000             36   ; Pin Definitions ;
0000             37   ;-----------------;
0000             38   SET_BUTTON           EQU P1.1 ; Pin 14
0000             39   
0000             40   DEC_BUTTON     EQU P0.5 ; Pin 1
0000             41   HOURS_BUTTON         EQU P3.0 ; Pin 5
0000             42   MINUTES_BUTTON       EQU P1.6 ; Pin 8
0000             43   SECONDS_BUTTON       EQU P1.5 ; Pin 10
0000             44   
0000             45   ALARM_OUT            EQU P1.7 ; Pin 6
0000             46   
0000             47   ;-------------------;
0000             48   ; Interrupt Vectors ;
0000             49   ;-------------------;
0000             50   ; Reset Vector
0000             51   ORG 0X0000
0000 0201C2      52       LJMP Main
0003             53   
0003             54   ; External Interrupt 0 Vector (Not Used)
0003             55   ORG 0X0003
0003 32          56            RETI
0004             57   
0004             58   ; Timer/Counter 0 Overflow Interrupt Vector
000B             59   ORG 0X000B
000B 020136      60            LJMP Timer0_ISR
000E             61   
000E             62   ; External Interrupt 1 vector (Not Used)
0013             63   ORG 0X0013
0013 32          64            RETI
0014             65   
0014             66   ; Timer/Counter 1 Overflow Interrupt Vector (Not Used)
001B             67   ORG 0X001B
001B 32          68            RETI
001C             69   
001C             70   ; Serial Port Receive/Transmit Interrupt Vector (Not Used)
0023             71   ORG 0X0023
0023 32          72            RETI
0024             73   
0024             74   ; Timer/Counter 2 Overflow Interrupt Vector
002B             75   ORG 0X002B
002B 020176      76            LJMP Timer2_ISR
002E             77   
002E             78   ; Note : Can Define Direct Access Variables Starting at 0X30 up to 0X7F in 8051.
0030             79   DSEG AT 0X30
0030             80   
0030             81   Counter_1ms:       DS 2 ; Used to Determine When 1000ms has Passed
0032             82   
0032             83   BCD_Time_Hours:    DS 1
0033             84   BCD_Time_Minutes:  DS 1
0034             85   BCD_Time_Seconds:  DS 1
0035             86   
0035             87   BCD_Alarm_Hours:   DS 1
0036             88   BCD_Alarm_Minutes: DS 1
0037             89   
0000             90   BSEG
0000             91   
0000             92   One_Second_Flag: DBIT 1 ; Set Bit In ISR After Every 1000ms
0001             93   
0001             94   Init_Time_Flag: DBIT 1 ; Set Bit When Time is Being Initialized
0002             95   Dec_En_Flag: DBIT 1 ; Set Bit When Decrement Button is Toggled
0003             96   
0003             97   Alarm_En_Flag:   DBIT 1
0004             98   Alarm_On_Flag:   DBIT 1
0005             99   
0005            100   Time_PM_Flag:    DBIT 1 ; Set Bit When Time is in PM
0006            101   Alarm_PM_Flag:   DBIT 1 ; Set Bit When Alarm is in PM
0007            102   
002E            103   CSEG
002E            104   
002E            105   LCD_RS EQU P1.3 ; Pin 12
002E            106   LCD_E  EQU P1.4 ; Pin 11
002E            107   LCD_D4 EQU P0.0 ; Pin 16
002E            108   LCD_D5 EQU P0.1 ; Pin 17
002E            109   LCD_D6 EQU P0.2 ; Pin 18
002E            110   LCD_D7 EQU P0.3 ; Pin 19
002E            111   
                113   	$LIST
00E2            115   
00E2 54494D45   116   TIME_INIT_MSG:     DB 'TIME xx:xx:xxxx', 0, 0
     2078783A
     78783A78
     78787800
     00
00F3 414C4152   117   ALARM_INIT_MSG:    DB 'ALARM xx:xxxx', 0
     4D207878
     3A787878
     7800
0101 414C4152   118   ALARM_UPDATE_MSG:  DB 'ALARM', 0
     4D00
0107            119   
0107 414D00     120   AM_MSG: DB 'AM', 0
010A 504D00     121   PM_MSG: DB 'PM', 0
010D            122   
010D 20202020   123   BLANK_DISPLAY: DB '                ', 0
     20202020
     20202020
     20202020
     00
011E 3A00       124   COLON: DB ':', 0
0120            125   
0120            126   ;---------------------------------------;
0120            127   ; Routine to Initialize ISR for Timer 0 ;
0120            128   ;---------------------------------------;
0120            129   Timer0_Init:
0120 438E08     130            ORL CKCON, #0B0000_1000 ; Input for Timer 0 is SYSCLK/1.
0123            131   
0123 E589       132            MOV A, TMOD
0125 54F0       133            ANL A, #0XF0 ; 1111_0000 Clear Bits for Timer 0
0127 4401       134            ORL A, #0X01 ; 0000_0001 Configure Timer 0 as 16-Timer
0129 F589       135            MOV TMOD, A
012B            136   
012B 758CF0     137            MOV TH0, #HIGH(TIMER0_RELOAD)
012E 758A2C     138            MOV TL0, #LOW(TIMER0_RELOAD)
0131            139   
0131            140            ; Enable Timer and Interrupts
0131 D2A9       141       SETB ET0  ; Enable Timer 0 Interrupt
0133 D28C       142            SETB TR0  ; Start Timer 0
0135 22         143            RET
0136            144   
0136            145   ;---------------------------------;
0136            146   ; ISR for Timer 0. Set to Execute ;
0136            147   ; Every 1/4096Hz to Generate a    ;
0136            148   ; 2048 Hz Wave at Pin ALARM_OUT   ;
0136            149   ;---------------------------------;
0136            150   Timer0_ISR:
0136            151            ; Save Registers to Stack.
0136 C0E0       152       PUSH ACC
0138 C0D0       153            PUSH PSW
013A            154   
013A 300311     155            JNB Alarm_En_Flag, No_Sound
013D 30040E     156            JNB Alarm_On_Flag, No_Sound
0140            157   Generate_Sound:
0140 C28C       158            CLR TR0 ; Stop Timer 0.
0142            159            ; Timer 0 Doesn't Have 16-Bit Auto-Reload.
0142 758CF0     160            MOV TH0, #HIGH(TIMER0_RELOAD)
0145 758A2C     161            MOV TL0, #LOW(TIMER0_RELOAD)
0148 D28C       162            SETB TR0
014A            163   
014A B297       164            CPL ALARM_OUT ; Toggle the Alarm Out Pin
014C 8006       165            SJMP Timer0_ISR_Done
014E            166   No_Sound:
014E            167            ; Timer 0 Doesn't Have 16-Bit Auto-Reload.
014E 758CF0     168            MOV TH0, #HIGH(TIMER0_RELOAD)
0151 758A2C     169            MOV TL0, #LOW(TIMER0_RELOAD)
0154            170   Timer0_ISR_Done:
0154            171            ; Restore Registers from Stack.
0154 D0D0       172            POP PSW
0156 D0E0       173            POP ACC
0158            174   
0158 32         175            RETI
0159            176   
0159            177   ;---------------------------------------;
0159            178   ; Routine to Initialize ISR for Timer 2 ;
0159            179   ;---------------------------------------;
0159            180   Timer2_Init:
0159 75C800     181            MOV T2CON, #0 ; Stop Timer. Autoreload Mode.
015C            182   
015C 75CDBF     183            MOV TH2, #HIGH(TIMER2_RELOAD)
015F 75CC28     184            MOV TL2, #LOW(TIMER2_RELOAD)
0162            185   
0162            186            ; Set Reload Value
0162 43C980     187            ORL T2MOD, #0X80 ; Enable Timer 2 Autoreload Mode
0165 75CBBF     188            MOV RCMP2H, #HIGH(TIMER2_RELOAD)
0168 75CA28     189            MOV RCMP2L, #LOW(TIMER2_RELOAD)
016B            190   
016B            191            ; Init 1ms Interrupt Counter. 16-bit Variable with Two 8-bit Parts.
016B E4         192            CLR A
016C F530       193            MOV Counter_1ms+0, A
016E F531       194            MOV Counter_1ms+1, A
0170            195   
0170            196            ; Enable the Timer and Interrupts.
0170 439B80     197            ORL EIE, #0X80 ; Enable Timer 2 Interrupt ET2=1
0173 D2CA       198       SETB TR2  ; Enable Timer 2
0175 22         199            RET
0176            200   
0176            201   ;-----------------;
0176            202   ; ISR for Timer 2 ;
0176            203   ;-----------------;
0176            204   Timer2_ISR:
0176 C2CF       205            CLR TF2  ; Timer 2 Doesn't Clear TF2 Automatically. Do it in the ISR.  It is Bit Addressable.
0178 B284       206            CPL P0.4 ; Interrupt Rate with Oscilloscope Must Precisely Be A 1ms Pulse.
017A            207   
017A            208            ; Save Registers to Stack
017A C0E0       209            PUSH ACC
017C C0D0       210            PUSH PSW
017E            211   
017E            212            ; Increment 16-bit 1ms Counter.
017E 0530       213            INC Counter_1ms+0 ; Increment Low 8-bits
0180 E530       214            MOV A, Counter_1ms+0 ; Increment High 8-bits if Lower 8-bits Overflow
0182 7002       215            JNZ Update_BCD
0184 0531       216            INC Counter_1ms+1
0186            217   Update_BCD:
0186            218            ; Check if 1000ms Have Passed
0186 E530       219            MOV A, Counter_1ms+0
0188 B4E832     220            CJNE A, #LOW(1000), Timer2_ISR_Done ; Note : Changes Carry Flag
018B E531       221            MOV A, Counter_1ms+1
018D B4032D     222            CJNE A, #HIGH(1000), Timer2_ISR_Done
0190            223   
0190            224            ; 1000ms Have Passed. Set Flag to Inform Main Program.
0190 D200       225            SETB One_Second_Flag
0192            226   Check_Alarm:
0192 30031E     227            JNB Alarm_En_Flag, No_Alarm
0195            228   
0195            229            ; Check if Time Hours Equals Alarm Hours
0195 E532       230            MOV A, BCD_Time_Hours
0197 B53519     231            CJNE A, BCD_Alarm_Hours, No_Alarm
019A            232   
019A            233            ; Check if Time Minutes Equals Alarm Minutes
019A E533       234            MOV A, BCD_Time_Minutes
019C B53614     235            CJNE A, BCD_Alarm_Minutes, No_Alarm
019F            236   
019F            237            ; Check AM/PM Flag
019F E4         238            CLR A
01A0 F5F0       239            MOV B, A
01A2 A205       240            MOV C, Time_PM_Flag
01A4 92F0       241            MOV B.0, C
01A6 A206       242            MOV C, Alarm_PM_Flag
01A8 92E0       243            MOV ACC.0, C
01AA B5F006     244            CJNE A, B, No_Alarm
01AD            245   BEEP:
01AD D204       246            SETB Alarm_On_Flag
01AF B28C       247            CPL TR0 ; Create Beep-Silence-Beep-Silence Sounds
01B1 8002       248            SJMP Continue_ISR
01B3            249   No_Alarm:
01B3 C204       250            CLR Alarm_On_Flag
01B5            251   Continue_ISR:
01B5            252            ; Reset 1ms Counter to 0.
01B5 E4         253            CLR A
01B6 F530       254            MOV Counter_1ms+0, A
01B8 F531       255            MOV Counter_1ms+1, A
01BA 12042C     256            LCALL Update_Time_Seconds
01BD            257   Timer2_ISR_Done:
01BD D0D0       258            POP PSW
01BF D0E0       259            POP ACC
01C1 32         260            RETI
01C2            261   
01C2            262   ;----------------------------------;
01C2            263   ; Main Program. Includes Hardware  ;
01C2            264   ; Initialization and Forever Loop. ;
01C2            265   ;----------------------------------;
01C2            266   Main:
01C2            267            ; Initialization
01C2 75817F     268       MOV SP, #0X7F
01C5 75B100     269       MOV P0M1, #0X00
01C8 75B200     270       MOV P0M2, #0X00
01CB 75B300     271       MOV P1M1, #0X00
01CE 75B400     272       MOV P1M2, #0X00
01D1 75AD00     273       MOV P3M2, #0X00
01D4 75AD00     274       MOV P3M2, #0X00
01D7            275   
01D7 120120     276       LCALL Timer0_Init
01DA 120159     277       LCALL Timer2_Init
01DD D2AF       278       SETB EA   ; Enable Global Interrupts
01DF 120087     279       LCALL LCD_4BIT
01E2            280   
01E2            281   Init_Time:
01E2 D201       282            SETB Init_Time_Flag
01E4 D200       283       SETB One_Second_Flag
01E6 C205       284            CLR Time_PM_Flag
01E8 C202       285            CLR Dec_En_Flag
01EA            286   
01EA C2CA       287            CLR TR2 ; Stop Timer 2
01EC            288   
01EC            289            ; Starting Display is 8:00:00 AM
01EC 7408       290            MOV A, #0X08
01EE F532       291            MOV BCD_Time_Hours, A
01F0            292   
01F0 7400       293            MOV A, #0X00
01F2 F533       294            MOV BCD_Time_Minutes, A
01F4            295   
01F4 7400       296            MOV A, #0X00
01F6 F534       297            MOV BCD_Time_Seconds, A
01F8            298   
01F8 C0E0       299            push acc
01FA 7401       299            mov a, #1
01FC 14         299            dec a
01FD 1200C7     299            lcall ?Set_Cursor_1 ; Select column and row
0200 D0E0       299            pop acc
0202 C083       300            push dph
0204 C082       300            push dpl
0206 C0E0       300            push acc
0208 9000E2     300            mov dptr, #TIME_INIT_MSG
020B 1200BA     300            lcall ?Send_Constant_String
020E D0E0       300            pop acc
0210 D082       300            pop dpl
0212 D083       300            pop dph
0214            301   Check_Set_Time:
0214 209112     302            JB SET_BUTTON, Init_Time_Display
0217 C002       303            push AR2
0219 7A32       303            mov R2, #50
021B 120038     303            lcall ?Wait_Milli_Seconds
021E D002       303            pop AR2
0220 209106     304            JB SET_BUTTON, Init_Time_Display
0223 3091FD     305            JNB SET_BUTTON, $ ; Wait for Rising Edge
0226 020271     306            LJMP Init_Time_End
0229            307   Init_Time_Display:
0229 1202CB     308            LCALL Update_Time_Display
022C 1204BC     309            LCALL Check_Dec_En
022F            310   Init_Time_Seconds:
022F 209512     311            JB SECONDS_BUTTON, Init_Time_Minutes
0232 C002       312            push AR2
0234 7A32       312            mov R2, #50
0236 120038     312            lcall ?Wait_Milli_Seconds
0239 D002       312            pop AR2
023B 209506     313            JB SECONDS_BUTTON, Init_Time_Minutes
023E 3095FD     314            JNB SECONDS_BUTTON, $ ; Wait for Rising Edge
0241 12042C     315            LCALL Update_Time_Seconds
0244            316   Init_Time_Minutes:
0244 209612     317            JB MINUTES_BUTTON, Init_Time_Hours
0247 C002       318            push AR2
0249 7A32       318            mov R2, #50
024B 120038     318            lcall ?Wait_Milli_Seconds
024E D002       318            pop AR2
0250 209606     319            JB MINUTES_BUTTON, Init_Time_Hours
0253 3096FD     320            JNB MINUTES_BUTTON, $ ; Wait for Rising Edge
0256 12041B     321            LCALL Update_Time_Minutes
0259            322   Init_Time_Hours:
0259 20B012     323            JB HOURS_BUTTON, Init_Time_Loop
025C C002       324            push AR2
025E 7A32       324            mov R2, #50
0260 120038     324            lcall ?Wait_Milli_Seconds
0263 D002       324            pop AR2
0265 20B006     325            JB HOURS_BUTTON, Init_Time_Loop
0268 30B0FD     326            JNB HOURS_BUTTON, $ ; Wait for Rising Edge
026B 1203FF     327            LCALL Update_Time_Hours
026E            328   Init_Time_Loop:
026E 020214     329            LJMP Check_Set_Time
0271            330   Init_Time_End:
0271 D2CA       331            SETB TR2 ; Set Timer 2
0273 C201       332            CLR Init_Time_Flag
0275            333   Init_Alarm:
0275 D203       334            SETB Alarm_En_Flag
0277 C204       335            CLR Alarm_On_Flag
0279            336   
0279            337            ; Starting Alarm is 06:00 AM
0279 C206       338            CLR Alarm_PM_Flag
027B 7406       339            MOV A, #0X06
027D F535       340            MOV BCD_Alarm_Hours, A
027F            341   
027F 7400       342            MOV A, #0X00
0281 F536       343            MOV BCD_Alarm_Minutes, A
0283            344   
0283 0202C0     345            LJMP Update_LCD_Display
0286            346   
0286            347   ;------------------------------------------------------;
0286            348   ; Forever Loop to Check Buttons and Update LCD Display ;
0286            349   ;------------------------------------------------------;
0286            350   Check_Buttons:
0286 8000       351            SJMP Check_Update_Alarm
0288            352   Check_Update_Alarm:
0288 1204A7     353            LCALL Check_Alarm_En
028B 1204BC     354            LCALL Check_Dec_En
028E 200303     355            JB Alarm_En_Flag, Check_Update_Alarm_Minutes
0291 0202C0     356            LJMP Update_LCD_Display
0294            357   Check_Update_Alarm_Minutes:
0294 209612     358            JB MINUTES_BUTTON, Check_Update_Alarm_Hours
0297 C002       359            push AR2
0299 7A32       359            mov R2, #50
029B 120038     359            lcall ?Wait_Milli_Seconds
029E D002       359            pop AR2
02A0 209606     360            JB MINUTES_BUTTON, Check_Update_Alarm_Hours
02A3 3096FD     361            JNB MINUTES_BUTTON, $ ; Wait for Rising Edge
02A6 120479     362            LCALL Update_Alarm_Minutes ; Increment Alarm Minutes
02A9            363   Check_Update_Alarm_Hours:
02A9 20B014     364            JB HOURS_BUTTON, Update_LCD_Display
02AC C002       365            push AR2
02AE 7A32       365            mov R2, #50
02B0 120038     365            lcall ?Wait_Milli_Seconds
02B3 D002       365            pop AR2
02B5 20B008     366            JB HOURS_BUTTON, Update_LCD_Display
02B8 30B0FD     367            JNB HOURS_BUTTON, $ ; Wait for Rising Edge
02BB 12043D     368            LCALL Update_Alarm_Hours ; Increment Alarm Hours
02BE 8000       369            SJMP Update_LCD_Display
02C0            370   Update_LCD_Display:
02C0 C200       371       CLR One_Second_Flag
02C2 1202CB     372            LCALL Update_Time_Display
02C5 120341     373            LCALL Update_Alarm_Display
02C8 020286     374            LJMP Check_Buttons
02CB            375   
02CB            376   ;--------------------;
02CB            377   ; Update LCD Display ;
02CB            378   ;--------------------;
02CB            379   Update_Time_Display:
02CB            380            ; Display Time
02CB C0E0       381            push acc
02CD 7406       381            mov a, #6
02CF 14         381            dec a
02D0 1200C7     381            lcall ?Set_Cursor_1 ; Select column and row
02D3 D0E0       381            pop acc
02D5 C000       382            push ar0
02D7 A832       382            mov r0, BCD_Time_Hours
02D9 1200CC     382            lcall ?Display_BCD
02DC D000       382            pop ar0
02DE C0E0       383            push acc
02E0 7409       383            mov a, #9
02E2 14         383            dec a
02E3 1200C7     383            lcall ?Set_Cursor_1 ; Select column and row
02E6 D0E0       383            pop acc
02E8 C000       384            push ar0
02EA A833       384            mov r0, BCD_Time_Minutes
02EC 1200CC     384            lcall ?Display_BCD
02EF D000       384            pop ar0
02F1 C0E0       385            push acc
02F3 740C       385            mov a, #12
02F5 14         385            dec a
02F6 1200C7     385            lcall ?Set_Cursor_1 ; Select column and row
02F9 D0E0       385            pop acc
02FB C000       386            push ar0
02FD A834       386            mov r0, BCD_Time_Seconds
02FF 1200CC     386            lcall ?Display_BCD
0302 D000       386            pop ar0
0304            387   
0304 20051D     388            JB Time_PM_Flag, Update_Time_PM
0307            389   Update_Time_AM:
0307 C0E0       390            push acc
0309 740E       390            mov a, #14
030B 14         390            dec a
030C 1200C7     390            lcall ?Set_Cursor_1 ; Select column and row
030F D0E0       390            pop acc
0311 C083       391            push dph
0313 C082       391            push dpl
0315 C0E0       391            push acc
0317 900107     391            mov dptr, #AM_MSG
031A 1200BA     391            lcall ?Send_Constant_String
031D D0E0       391            pop acc
031F D082       391            pop dpl
0321 D083       391            pop dph
0323 22         392            RET
0324            393   Update_Time_PM:
0324 C0E0       394            push acc
0326 740E       394            mov a, #14
0328 14         394            dec a
0329 1200C7     394            lcall ?Set_Cursor_1 ; Select column and row
032C D0E0       394            pop acc
032E C083       395            push dph
0330 C082       395            push dpl
0332 C0E0       395            push acc
0334 90010A     395            mov dptr, #PM_MSG
0337 1200BA     395            lcall ?Send_Constant_String
033A D0E0       395            pop acc
033C D082       395            pop dpl
033E D083       395            pop dph
0340 22         396            RET
0341            397   
0341            398   Update_Alarm_Display:
0341 200303     399            JB Alarm_En_Flag, Update_Alarm_En_On
0344 0203E2     400            LJMP Update_Alarm_En_Off
0347            401   Update_Alarm_En_On:
0347            402            ; Display Alarm
0347 C0E0       403            push acc
0349 7401       403            mov a, #1
034B 14         403            dec a
034C 1200C5     403            lcall ?Set_Cursor_2 ; Select column and row
034F D0E0       403            pop acc
0351 C083       404            push dph
0353 C082       404            push dpl
0355 C0E0       404            push acc
0357 900101     404            mov dptr, #ALARM_UPDATE_MSG
035A 1200BA     404            lcall ?Send_Constant_String
035D D0E0       404            pop acc
035F D082       404            pop dpl
0361 D083       404            pop dph
0363 C0E0       405            push acc
0365 7407       405            mov a, #7
0367 14         405            dec a
0368 1200C5     405            lcall ?Set_Cursor_2 ; Select column and row
036B D0E0       405            pop acc
036D C000       406            push ar0
036F A835       406            mov r0, BCD_Alarm_Hours
0371 1200CC     406            lcall ?Display_BCD
0374 D000       406            pop ar0
0376 C0E0       407            push acc
0378 7409       407            mov a, #9
037A 14         407            dec a
037B 1200C5     407            lcall ?Set_Cursor_2 ; Select column and row
037E D0E0       407            pop acc
0380 C083       408            push dph
0382 C082       408            push dpl
0384 C0E0       408            push acc
0386 90011E     408            mov dptr, #COLON
0389 1200BA     408            lcall ?Send_Constant_String
038C D0E0       408            pop acc
038E D082       408            pop dpl
0390 D083       408            pop dph
0392            408   
0392 C0E0       409            push acc
0394 740A       409            mov a, #10
0396 14         409            dec a
0397 1200C5     409            lcall ?Set_Cursor_2 ; Select column and row
039A D0E0       409            pop acc
039C C000       410            push ar0
039E A836       410            mov r0, BCD_Alarm_Minutes
03A0 1200CC     410            lcall ?Display_BCD
03A3 D000       410            pop ar0
03A5            411   
03A5 20061D     412            JB Alarm_PM_Flag, Update_Alarm_PM
03A8            413   Update_Alarm_AM:
03A8 C0E0       414            push acc
03AA 740C       414            mov a, #12
03AC 14         414            dec a
03AD 1200C5     414            lcall ?Set_Cursor_2 ; Select column and row
03B0 D0E0       414            pop acc
03B2 C083       415            push dph
03B4 C082       415            push dpl
03B6 C0E0       415            push acc
03B8 900107     415            mov dptr, #AM_MSG
03BB 1200BA     415            lcall ?Send_Constant_String
03BE D0E0       415            pop acc
03C0 D082       415            pop dpl
03C2 D083       415            pop dph
03C4 22         416       RET
03C5            417   Update_Alarm_PM:
03C5 C0E0       418            push acc
03C7 740C       418            mov a, #12
03C9 14         418            dec a
03CA 1200C5     418            lcall ?Set_Cursor_2 ; Select column and row
03CD D0E0       418            pop acc
03CF C083       419            push dph
03D1 C082       419            push dpl
03D3 C0E0       419            push acc
03D5 90010A     419            mov dptr, #PM_MSG
03D8 1200BA     419            lcall ?Send_Constant_String
03DB D0E0       419            pop acc
03DD D082       419            pop dpl
03DF D083       419            pop dph
03E1 22         420       RET
03E2            421   Update_Alarm_En_Off:
03E2 C0E0       422            push acc
03E4 7401       422            mov a, #1
03E6 14         422            dec a
03E7 1200C5     422            lcall ?Set_Cursor_2 ; Select column and row
03EA D0E0       422            pop acc
03EC C083       423            push dph
03EE C082       423            push dpl
03F0 C0E0       423            push acc
03F2 90010D     423            mov dptr, #BLANK_DISPLAY
03F5 1200BA     423            lcall ?Send_Constant_String
03F8 D0E0       423            pop acc
03FA D082       423            pop dpl
03FC D083       423            pop dph
03FE 22         424            RET
03FF            425   
03FF            426   ;-------------------------------;
03FF            427   ; Update Time on LCD Display ;
03FF            428   ;-------------------------------;
03FF            429   Update_Time_Hours:
03FF E532       430                    MOV A, BCD_Time_Hours
0401 2401       431            ADD A, #1
0403 D4         432            DA A
0404 F532       433            MOV BCD_Time_Hours, A
0406 9412       434            SUBB A, #0X12
0408 4010       435            JC Update_Time_Hours_Done
040A 7007       436            JNZ Offset_Time_Hours
040C            437   Toggle_Time_AMPM:
040C 753212     438            MOV BCD_Time_Hours, #0X12
040F B205       439            CPL Time_PM_Flag
0411 8007       440            SJMP Update_Time_Hours_Done
0413            441   Offset_Time_Hours:
0413 E532       442            MOV A, BCD_Time_Hours
0415 9412       443            SUBB A, #0X12
0417 D4         444            DA A
0418 F532       445            MOV BCD_Time_Hours, A
041A            446   Update_Time_Hours_Done:
041A 22         447            RET
041B            448   
041B            449   Update_Time_Minutes:
041B E533       450                    MOV A, BCD_Time_Minutes
041D 2401       451            ADD A, #1
041F D4         452            DA A
0420 F533       453            MOV BCD_Time_Minutes, A
0422 B46006     454            CJNE A, #0X60, Update_Time_Minutes_Done
0425 753300     455                    MOV BCD_Time_Minutes, #0X00
0428 1203FF     456            LCALL Update_Time_Hours
042B            457            Update_Time_Minutes_Done:
042B 22         458            RET
042C            459   
042C            460   Update_Time_Seconds:
042C E534       461                    MOV A, BCD_Time_Seconds
042E 2401       462            ADD A, #1
0430 D4         463            DA A
0431 F534       464            MOV BCD_Time_Seconds, A
0433 B46006     465            CJNE A, #0X60, Update_Time_Seconds_Done
0436 753400     466                    MOV BCD_Time_Seconds, #0X00
0439 12041B     467            LCALL Update_Time_Minutes
043C            468            Update_Time_Seconds_Done:
043C 22         469            RET
043D            470   
043D            471   Update_Alarm_Hours:
043D 300203     472            JNB Dec_En_Flag, Inc_Alarm_Hours
0440 020461     473            LJMP Dec_Alarm_Hours
0443            474   
0443            475   Inc_Alarm_Hours:
0443 E535       476            MOV A, BCD_Alarm_Hours
0445 2401       477            ADD A, #1
0447 D4         478            DA A
0448 F535       479            MOV BCD_Alarm_Hours, A
044A 9412       480            SUBB A, #0X12
044C 4012       481            JC Update_Alarm_Hours_Done
044E 7007       482            JNZ Offset_Alarm_Hours
0450            483   Toggle_Alarm_AMPM:
0450 753512     484            MOV BCD_Alarm_Hours, #0X12
0453 B206       485            CPL Alarm_PM_Flag
0455 8009       486            SJMP Update_Alarm_Hours_Done
0457            487   Offset_Alarm_Hours:
0457 E535       488            MOV A, BCD_Alarm_Hours
0459 9412       489            SUBB A, #0X12
045B D4         490            DA A
045C F535       491            MOV BCD_Alarm_Hours, A
045E 8000       492            SJMP Update_Alarm_Hours_Done
0460            493   Update_Alarm_Hours_Done:
0460 22         494            RET
0461            495   
0461            496   Dec_Alarm_Hours:
0461 E535       497            MOV A, BCD_Alarm_Hours
0463 B41207     498            CJNE A, #0X12, Dec_Alarm_Hours_Continued
0466            499   Rewind_Alarm_AMPM:
0466 753511     500            MOV BCD_Alarm_Hours, #0X11
0469 B206       501            CPL Alarm_PM_Flag
046B 80F3       502            SJMP Update_Alarm_Hours_Done
046D            503   Dec_Alarm_Hours_Continued:
046D 2499       504            ADD A, #0X99 ; Adding 10-Complement of -1
046F D4         505            DA A
0470 F535       506            MOV BCD_Alarm_Hours, A
0472 70EC       507            JNZ Update_Alarm_Hours_Done
0474            508   Rewind_Alarm_Hours:
0474 753512     509            MOV BCD_Alarm_Hours, #0X12
0477 80E7       510            SJMP Update_Alarm_Hours_Done
0479            511   
0479            512   
0479            513   Update_Alarm_Minutes:
0479 300203     514            JNB Dec_En_Flag, Inc_Alarm_Minutes
047C 020494     515            LJMP Dec_Alarm_Minutes
047F            516   
047F            517   Inc_Alarm_Minutes:
047F E536       518            MOV A, BCD_Alarm_Minutes
0481 2401       519            ADD A, #1
0483 D4         520            DA A
0484 F536       521            MOV BCD_Alarm_Minutes, A
0486 B4600A     522            CJNE A, #0X60, Update_Alarm_Minutes_Done
0489 8000       523            SJMP Reset_Alarm_Minutes
048B            524   Reset_Alarm_Minutes:
048B 753600     525            MOV BCD_Alarm_Minutes, #0X00
048E 12043D     526            LCALL Update_Alarm_Hours
0491 8000       527            SJMP Update_Alarm_Minutes_Done
0493            528   Update_Alarm_Minutes_Done:
0493 22         529            RET
0494            530   
0494            531   Dec_Alarm_Minutes:
0494 E536       532            MOV A, BCD_Alarm_Minutes
0496 7008       533            JNZ Dec_Alarm_Minutes_Continued
0498            534   Rewind_Alarm_Minutes:
0498 753659     535            MOV BCD_Alarm_Minutes, #0X59
049B 12043D     536            LCALL Update_Alarm_Hours
049E 80F3       537            SJMP Update_Alarm_Minutes_Done
04A0            538   Dec_Alarm_Minutes_Continued:
04A0 2499       539            ADD A, #0X99 ; Adding 10-Complement of -1
04A2 D4         540            DA A
04A3 F536       541            MOV BCD_Alarm_Minutes, A
04A5 80EC       542            SJMP Update_Alarm_Minutes_Done
04A7            543   
04A7            544   ;----------------;
04A7            545   ; Enable/Disable ;
04A7            546   ;----------------;
04A7            547   Check_Alarm_En:
04A7 209111     548            JB SET_BUTTON, Check_Alarm_En_Done
04AA C002       549            push AR2
04AC 7A32       549            mov R2, #50
04AE 120038     549            lcall ?Wait_Milli_Seconds
04B1 D002       549            pop AR2
04B3 209105     550            JB SET_BUTTON, Check_Alarm_En_Done
04B6 3091FD     551            JNB SET_BUTTON, $ ; Wait for Rising Edge
04B9 B203       552            CPL Alarm_En_Flag ; Toggle Alarm Enable Flag
04BB            553   Check_Alarm_En_Done:
04BB 22         554            RET
04BC            555   
04BC            556   Check_Dec_En:
04BC 208511     557            JB DEC_BUTTON, Check_Dec_En_Done
04BF C002       558            push AR2
04C1 7A32       558            mov R2, #50
04C3 120038     558            lcall ?Wait_Milli_Seconds
04C6 D002       558            pop AR2
04C8 208505     559            JB DEC_BUTTON, Check_Dec_En_Done
04CB 3085FD     560            JNB DEC_BUTTON, $ ; Wait for Rising Edge
04CE B202       561            CPL Dec_En_Flag
04D0            562   Check_Dec_En_Done:
04D0 22         563            RET
04D1            564   END
